
// Ascensión bundle — inject CSS + override Exchange.card (drop-in, no backend changes)
(function(){
  var css = `
:root {
  --asc-card-bg: #fff;
  --asc-surface: #f7efe6;
  --asc-chip-bg: #eae1d6;
  --asc-chip-text: #6b4f3b;
  --asc-accent: #8b6f56;
  --asc-accent-strong: #6a4f3b;
  --asc-success: #2e7d32;
  --asc-danger: #b00020;
  --asc-warning: #a15c00;
  --asc-muted: #7a7067;
  --asc-shadow: 0 4px 10px rgba(0,0,0,.06);
}
.asc-card { background: var(--asc-card-bg); border-radius: 14px; box-shadow: var(--asc-shadow); padding: 1rem; border: 1px solid rgba(0,0,0,.04); }
.asc-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.asc-chip { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius: 999px; font-size: .72rem; font-weight: 700; letter-spacing:.02em; background: var(--asc-chip-bg); color: var(--asc-chip-text); text-transform: uppercase; }
.asc-chip.status-proposed { background: #e8f0fe; color:#1a4fb3; } .asc-chip.status-accepted { background: #e7f6ec; color: var(--asc-success); } .asc-chip.status-declined { background: #fdecea; color: var(--asc-danger); } .asc-chip.status-cancelled { background: #f1f1f1; color: var(--asc-muted); } .asc-chip.status-completed { background: #ede7f6; color: #5e35b1; }
.asc-chip.role-in   { background:#fff5e5; color:#a15c00; } .asc-chip.role-out  { background:#eef3f0; color:#4f6a5b; } .asc-chip.type-loan { background:#fff0f0; color:#a23b3b; }
.asc-book-block h5 { margin:0 0 .15rem 0; font-size: .95rem; color: var(--asc-accent-strong); }
.asc-book-block .by { font-size:.82rem; color: var(--asc-muted); }
.asc-meta { font-size:.8rem; color: var(--asc-muted); display:flex; gap:.5rem; align-items:center; margin-top:.25rem; }
.asc-bubble { background: #fff8e6; border-left: 4px solid #ffdd99; padding:.6rem .75rem; border-radius: 10px; color:#5f4a2e; margin-top:.5rem; font-size:.9rem; }
.asc-actions { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.75rem; }
.asc-btn { border:1px solid var(--asc-accent); background:#fff; color: var(--asc-accent-strong); padding:.55rem .8rem; border-radius:10px; font-weight:600; cursor:pointer; }
.asc-btn.primary { background: var(--asc-accent); color:#fff; border-color: var(--asc-accent); }
.asc-btn.success { background: var(--asc-success); color:#fff; border-color: var(--asc-success); }
.asc-btn.danger  { background: var(--asc-danger);  color:#fff; border-color: var(--asc-danger); }
.asc-btn.ghost   { background:#fff; color: var(--asc-muted); border-color:#ddd; }
.asc-divider { height:1px; background: rgba(0,0,0,.06); margin:.75rem 0; }
@media (max-width:920px) { .asc-row { grid-template-columns: 1fr; } }
`;
  var styleEl = document.createElement('style');
  styleEl.setAttribute('id','ascension-bundle-css');
  styleEl.appendChild(document.createTextNode(css));
  document.head.appendChild(styleEl);

  function fmt(dt) {
    try { return new Date(dt).toLocaleString('es-ES',{dateStyle:'short',timeStyle:'short'}); }
    catch(_) { return '—'; }
  }
  function coverHTML(book){
    if (book && book.front_url) {
      return '<img src="'+book.front_url+'" alt="'+(book.title||'')+'" style="width:56px;height:80px;object-fit:cover;border-radius:8px;box-shadow:0 3px 8px rgba(0,0,0,.08)>';
    }
    return '<div class="hist-thumb" style="width:56px;height:80px;border-radius:8px;background:#f1eee9;display:grid;place-items:center"><i class="fas fa-book" style="color:#9a8f84"></i></div>';
  }
  function chips(ex, isRequester){
    var out = [];
    var status = (ex.status || 'proposed').toLowerCase();
    out.push('<span class="asc-chip status-'+status+'">'+status.toUpperCase()+'</span>');
    out.push('<span class="asc-chip '+(isRequester ? 'role-out':'role-in')+'">'+(isRequester?'Enviada':'Recibida')+'</span>');
    if (ex.transaction_type === 'loan') out.push('<span class="asc-chip type-loan">Préstamo</span>');
    return out.join(' ');
  }
  function buildActions(ex, isRequester){
    var actions = '';
    var isLoan = ex.transaction_type === 'loan';
    var youConf = isRequester ? ex.requester_confirmed : ex.owner_confirmed;
    var otherConf = isRequester ? ex.owner_confirmed : ex.requester_confirmed;
    if (ex.status === 'proposed') {
      actions = isRequester
        ? '<button class="asc-btn ghost" onclick="Exchange.updateStatus(\''+ex.id+'\',\'cancelled\')">Cancelar</button>'
        : '<button class="asc-btn success" onclick="Exchange.updateStatus(\''+ex.id+'\',\'accepted\')">Aceptar</button>'
          + ' <button class="asc-btn danger" onclick="Exchange.updateStatus(\''+ex.id+'\',\'declined\')">Rechazar</button>';
    } else if (ex.status === 'accepted') {
      if (youConf && otherConf) {
        actions = '<span class="asc-chip status-completed"><i class="fas fa-check"></i> Ambos confirmaron</span>';
      } else if (youConf && !otherConf) {
        actions = '<span class="asc-chip role-out">Ya confirmaste. Esperando a la otra persona…</span>';
      } else {
        actions = '<button class="asc-btn primary" onclick="Exchange.confirm(\''+ex.id+'\')"><i class="fas fa-check"></i> Confirmar '+(isLoan?'préstamo':'intercambio')+'</button>';
      }
    }
    actions += ' <button class="asc-btn" onclick="(window.UI && UI.openThreema) ? UI.openThreema(\''+ex.id+'\') : alert(\'Usa vuestro canal de contacto habitual\')">Contactar por Threema</button>';
    return actions;
  }
  function twoCol(headingLeft, bookLeft, headingRight, bookRight, ex){
    var when = ex.meeting_time ? fmt(ex.meeting_time) : '—';
    var place = ex.meeting_place || '—';
    return ''
    + '<div class="asc-row">'
      + '<div style="display:flex;gap:.75rem;align-items:flex-start">'
        + coverHTML(bookLeft)
        + '<div class="asc-book-block">'
          + '<div class="asc-chip" style="opacity:.9">'+headingLeft+'</div>'
          + '<h5>' + ((bookLeft && bookLeft.title) || '—') + '</h5>'
          + '<div class="by">' + ((bookLeft && bookLeft.author) || '') + '</div>'
          + '<div class="asc-meta"><i class="fas fa-map-marker-alt"></i>'+place+' · <i class="far fa-calendar"></i>'+when+'</div>'
        + '</div>'
      + '</div>'
      + '<div style="display:flex;gap:.75rem;align-items:flex-start;justify-content:flex-start">'
        + coverHTML(bookRight)
        + '<div class="asc-book-block">'
          + '<div class="asc-chip" style="opacity:.9)">'+headingRight+'</div>'
          + '<h5>' + ((bookRight && bookRight.title) || '—') + '</h5>'
          + '<div class="by">' + ((bookRight && bookRight.author) || '') + '</div>'
          + '<div class="asc-meta"><i class="fas fa-exchange-alt"></i>Intercambio</div>'
        + '</div>'
      + '</div>'
    + '</div>';
  }
  function cardAsc(ex, booksInfo){
    var isRequester = ex.requester_id === (window.currentUser && currentUser.id);
    var requestedBook = booksInfo[ex.requested_book_id] || {};
    var offeredBook   = booksInfo[ex.offered_book_id]   || {};
    var header = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">'+chips(ex, isRequester)+'</div>';
    var cols = isRequester
      ? twoCol('Ofreces', offeredBook, 'Solicitas', requestedBook, ex)
      : twoCol('Te ofrecen', requestedBook, 'Te solicitan', offeredBook, ex);
    var note = ex.note ? '<div class="asc-bubble"><i class="fas fa-comment"></i> '+ex.note+'</div>' : '';
    var actions = '<div class="asc-actions">'+buildActions(ex, isRequester)+'</div>';
    return '<div class="asc-card">'+header+cols+'<div class="asc-divider"></div>'+note+actions+'</div>';
  }
  function patchExchangeCard(){
    if (!window.Exchange || !Exchange.card) return;
    if (!Exchange.__originalCard) Exchange.__originalCard = Exchange.card;
    Exchange.card = function(ex, booksInfo){ return cardAsc(ex, booksInfo); };
    console.info('[Ascensión bundle] Exchange.card() override activo');
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', patchExchangeCard);
  else patchExchangeCard();
})();
