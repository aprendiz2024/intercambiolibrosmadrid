<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Intercambio Libros Madrid</title>

<!-- PWA Meta Tags -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#8B6941">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ILM">
<link rel="apple-touch-icon" href="/icon-192.png">

<!-- iOS Splash Screens -->
<link rel="apple-touch-startup-image" href="/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
<link rel="apple-touch-startup-image" href="/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">

<!-- Standard Favicon -->
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary-wood:#8B6941;
  --primary-accent:#9B7653;
  --primary-soft:#F5E6D3;
  --primary-pale:#FAF4ED;
  --text-primary:#3E2723;
  --text-secondary:#5D4037;
  --text-hint:#BCAAA4;
  --surface:#fff;
  --bg:#FBF7F3;
  --success:#5D8A5D;
  --warning:#CC7A00;
  --error:#B85450;
  --shadow:0 2px 10px rgba(139,105,65,.18);
  --radius:12px;
  --space:.75rem;
  --space-lg:1.25rem;
  --space-xl:1.75rem;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;background:var(--bg);color:var(--text-primary)}

/* auth */
.auth-wrapper{min-height:100vh;display:grid;place-items:center;padding:var(--space-xl)}
.auth-card{max-width:460px;width:100%;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:var(--space-xl)}
.auth-title{margin:0 0 var(--space);display:flex;gap:.6rem;align-items:center;font-weight:800;color:var(--primary-wood)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.form-group{margin-bottom:var(--space)}
.form-label{display:block;font-size:.9rem;margin-bottom:.35rem;color:var(--text-secondary)}
.form-input,.form-select,.form-textarea{width:100%;border:1px solid var(--primary-soft);background:#fff;padding:.75rem .8rem;border-radius:10px;outline:none}
.form-textarea{min-height:84px;resize:vertical}
.btn{display:inline-flex;align-items:center;justify-content:center;border:none;border-radius:10px;padding:.8rem 1rem;gap:.5rem;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
.btn:disabled{opacity:.7;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--primary-wood),var(--primary-accent));color:#fff}
.btn-secondary{background:#fff;border:1px solid var(--primary-soft)}
.btn-text{background:transparent;border:none;color:var(--primary-wood);cursor:pointer;padding:.4rem;text-decoration:underline}
.hint{font-size:.85rem;color:var(--text-hint)}
.divider{height:1px;background:var(--primary-soft);margin:var(--space-lg) 0}
.oauth-row{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
.oauth-btn{border:1px dashed var(--primary-soft);background:#fff;border-radius:10px;padding:.6rem;display:flex;align-items:center;justify-content:center;gap:.4rem;cursor:pointer}

/* app */
.app-container{max-width:960px;margin:0 auto;padding-bottom:110px}
@supports (padding: max(0px)) {.app-container{ padding-bottom:max(110px, env(safe-area-inset-bottom)); }}
.app-header{position:sticky;top:0;background:#fff;display:flex;justify-content:space-between;align-items:center;padding:var(--space);z-index:20;border-bottom:1px solid var(--primary-soft)}
.logo{display:flex;gap:.6rem;align-items:center;font-weight:800;color:var(--primary-wood)}
.header-actions{display:flex;align-items:center;gap:.5rem}
.points{display:inline-flex;gap:.4rem;align-items:center;background:var(--primary-soft);padding:.35rem .6rem;border-radius:999px}
.notification-btn,.profile-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--primary-soft);background:#fff;display:grid;place-items:center;cursor:pointer}
.nav-tabs{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--primary-soft);display:grid;grid-template-columns:repeat(4,1fr);z-index:20}
.nav-tab{padding:.55rem 0;display:grid;place-items:center;border:none;background:#fff;color:var(--text-secondary);gap:.25rem;cursor:pointer}
.nav-tab.active{color:var(--primary-wood);font-weight:700}
.main-content{padding:var(--space)} .page{display:none} .page.active{display:block}

/* books */
.books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.75rem}
.book-card{background:#fff;border:1px solid var(--primary-soft);border-radius:12px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow);transition:transform .15s}
.book-card:hover{transform:translateY(-2px)}
.book-cover{height:160px;background:linear-gradient(135deg,var(--primary-wood),var(--primary-accent));display:grid;place-items:center;color:#fff;position:relative}
.book-cover img{width:100%;height:100%;object-fit:cover}
.book-info{padding:.7rem}
.book-title{font-weight:700;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.book-author{font-size:.9rem;color:var(--text-secondary)}
.badge{display:inline-block;border-radius:999px;padding:.15rem .5rem;background:var(--primary-soft);font-size:.75rem}

/* matches: títulos/autores blancos encima de portada */
#matchContainer .book-title, #matchContainer .book-author{ color:#fff!important; text-shadow:0 1px 2px rgba(0,0,0,.6); }

/* empty & toast */
.empty{border:1px dashed var(--primary-soft);border-radius:12px;padding:2rem;text-align:center;color:var(--text-secondary);background:#fff}
.empty i{font-size:2rem;margin-bottom:.5rem;color:var(--primary-wood)}
.toast{position:fixed;top:84px;left:50%;transform:translateX(-50%);background:var(--primary-wood);color:#fff;border-radius:999px;padding:.6rem 1rem;z-index:9999;box-shadow:var(--shadow);font-weight:600}
.toast.success{background:var(--success)} .toast.error{background:var(--error)} .toast.warning{background:var(--warning)}

/* modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-start;justify-content:center;padding:6vh var(--space);overflow-y:auto}
.modal.active{display:flex}
.modal-card{max-width:560px;width:100%;background:#fff;border-radius:14px;padding:var(--space-lg);box-shadow:var(--shadow);max-height:calc(100vh - 12vh);overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
.close{background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--text-secondary)}
body.modal-open{overflow:hidden}

/* uploader */
.uploader-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin:.5rem 0 0}
@media(min-width:560px){ .uploader-grid{ grid-template-columns:repeat(4,1fr); } }
.upload-card{border:2px dashed var(--primary-soft);border-radius:12px;background:#fff8f1;min-height:120px;padding:.6rem;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:.35rem;position:relative;overflow:hidden;cursor:pointer}
.upload-card.required{background:#fff3e0}
.upload-card .hint{font-size:.75rem}
.upload-card input[type=file]{display:none}
.upload-card .preview{position:absolute;inset:0;background-size:cover;background-position:center;border-radius:10px;opacity:.95;display:none}
.upload-card.has-image .preview{display:block}
.upload-card .overlay{position:absolute;inset:auto 6px 6px auto;background:rgba(0,0,0,.55);color:#fff;padding:.15rem .35rem;border-radius:8px;font-size:.7rem;display:none}
.upload-card.has-image .overlay{display:block}
.upload-card button.remove{position:absolute;top:6px;right:6px;background:#fff;border:1px solid var(--primary-soft);border-radius:10px;width:28px;height:28px;display:grid;place-items:center;cursor:pointer}

/* password helpers */
.password-wrap{ position:relative; }
.password-wrap .toggle-eye{ position:absolute; right:.6rem; top:50%; transform:translateY(-50%); border:1px solid var(--primary-soft); background:#fff; width:34px; height:34px; border-radius:8px; display:grid; place-items:center; cursor:pointer; color:var(--text-secondary); }
.pw-hint{ font-size:.8rem; color:var(--text-hint); margin-top:.35rem; }
.pw-checklist{ margin:.35rem 0 0; padding:0; list-style:none; font-size:.85rem; }
.pw-checklist li{ display:flex; align-items:center; gap:.4rem; color:#9a877a; }
.pw-checklist li.ok{ color:#4c8b4c; }
.pw-checklist i{ width:16px; text-align:center; }

/* placeholders más contrastados */
.form-input::placeholder,.form-textarea::placeholder{ color:#b49a8b; opacity:1; }

/* Miniaturas del HISTORIAL */
.hist-thumb{
  width:72px;
  height:104px;
  border-radius:8px;
  background:var(--primary-soft);
  display:inline-grid;
  place-items:center;
  overflow:hidden;
  object-fit:cover;
  box-shadow:var(--shadow);
}
.hist-thumb i{ color:var(--text-hint); font-size:1rem; }
.hist-thumb.clickable{ cursor:pointer; transition:transform .15s; }
.hist-thumb.clickable:hover{ transform:translateY(-2px); }

/* Links dentro del historial */
#profileHistory a{ color:var(--primary-wood); text-decoration:underline; }

/* Asegura que el contenedor alinee bien las miniaturas y textos */
#profileHistory .hist-row{ display:flex; gap:.75rem; align-items:center; }

/* Exchange card styles */
.exchange-card{
  background:#fff;
  border:1px solid var(--primary-soft);
  border-radius:12px;
  padding:1rem;
  margin-bottom:.75rem;
  box-shadow:var(--shadow);
}

.zone-badge{
  display:inline-block;
  background:var(--primary-accent);
  color:#fff;
  padding:.25rem .5rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:600;
}

/* Weekly club card */
.card{
  background:#fff;
  border:1px solid var(--primary-soft);
  border-radius:12px;
  padding:1rem;
  box-shadow:var(--shadow);
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

/* Configuration warning */
.config-warning {
  background: #FFF3CD;
  border: 1px solid #FFEAA7;
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem;
  text-align: center;
  color: #7A5A00;
}

/* ===== COMMUNITY & INTEREST DISCOVERY STYLES ===== */

/* Grids para grupos e intereses */
.groups-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.group-card {
  background: #fff;
  border: 1px solid var(--primary-soft);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: var(--shadow);
  transition: transform 0.2s;
}

.group-card:hover {
  transform: translateY(-2px);
}

.group-header {
  display: flex;
  align-items: center;
  gap: .5rem;
  margin-bottom: .75rem;
}

.group-stats {
  display: flex;
  gap: 1rem;
  margin: .5rem 0;
  font-size: .85rem;
  color: var(--text-secondary);
}

/* Tags de intereses */
.interest-tags {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  margin-bottom: 1.5rem;
}

.interest-tag {
  background: #fff;
  border: 1px solid var(--primary-soft);
  border-radius: 25px;
  padding: .5rem 1rem;
  cursor: pointer;
  transition: all 0.2s;
  font-size: .9rem;
}

.interest-tag:hover {
  background: var(--primary-soft);
}

.interest-tag.selected {
  background: var(--primary-wood);
  color: #fff;
  border-color: var(--primary-wood);
}

/* Grid de motivaciones */
.motivation-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.motivation-card {
  background: #fff;
  border: 1px solid var(--primary-soft);
  border-radius: 12px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.2s;
  display: block;
}

.motivation-card:hover {
  border-color: var(--primary-wood);
  transform: translateY(-2px);
}

.motivation-card input {
  display: none;
}

.motivation-card input:checked + .card-content {
  background: var(--primary-pale);
}

.motivation-card .card-content {
  text-align: center;
  transition: background 0.2s;
  border-radius: 8px;
  padding: .5rem;
}

.motivation-card h6 {
  margin: 0 0 .5rem;
  font-weight: 600;
}

.motivation-card p {
  margin: 0;
  font-size: .85rem;
  color: var(--text-secondary);
}

.category-section {
  margin-bottom: 2rem;
}

/* Indicador de club activo */
.club-indicator {
  position: relative;
}

.club-indicator::before {
  content: '';
  position: absolute;
  top: -8px;
  right: -8px;
  width: 12px;
  height: 12px;
  background: var(--success);
  border-radius: 50%;
  animation: pulse-indicator 2s infinite;
}

@keyframes pulse-indicator {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

/* Responsive para móviles */
@media (max-width: 560px) {
  .groups-grid {
    grid-template-columns: 1fr;
  }
  
  .motivation-grid {
    grid-template-columns: 1fr;
  }
  
  .interest-tags {
    gap: .35rem;
  }
  
  .interest-tag {
    padding: .4rem .8rem;
    font-size: .85rem;
  }
}

/* New styles for completed functionality */
.group-creation-form {
  background: var(--primary-pale);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.member-list {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  margin-top: .5rem;
}

.member-avatar {
  width: 32px;
  height: 32px;
  background: var(--primary-wood);
  color: #fff;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: .8rem;
  font-weight: 600;
}

.activity-feed {
  max-height: 300px;
  overflow-y: auto;
  background: var(--bg);
  border-radius: 8px;
  padding: 1rem;
}

.activity-item {
  display: flex;
  gap: .75rem;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--primary-soft);
}

.activity-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--primary-soft);
  border-radius: 50%;
  border-top-color: var(--primary-wood);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.success-checkmark {
  color: var(--success);
  font-size: 1.2rem;
  animation: checkmark-appear 0.3s ease-in-out;
}

@keyframes checkmark-appear {
  0% { transform: scale(0); }
  100% { transform: scale(1); }
}
</style>
</head>
<body>

<!-- Configuration Warning -->
<div id="configWarning" class="config-warning" style="display:none">
  <i class="fas fa-exclamation-triangle"></i>
  <strong>Configuración pendiente:</strong> 
  Esta aplicación requiere configurar las credenciales de  para funcionar correctamente.
  <br><small>Las credenciales actuales son placeholders y deben ser reemplazadas.</small>
</div>

<!-- AUTH -->
<div id="auth" class="auth-wrapper">
  <div class="auth-card">
    <h2 class="auth-title"><i class="fas fa-book-open"></i> Intercambio Libros Madrid</h2>

    <!-- LOGIN -->
    <div id="loginView">
      <form onsubmit="Auth.handleLogin(event)">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input id="loginEmail" type="email" class="form-input" autocomplete="email" placeholder="tucorreo@dominio.com">
        </div>

        <div class="form-group">
          <label class="form-label">Contraseña</label>
          <div class="password-wrap">
            <input id="loginPassword" type="password" class="form-input" autocomplete="current-password" placeholder="********">
            <button type="button" class="toggle-eye" onclick="PasswordUI.toggle('loginPassword', this)"><i class="far fa-eye"></i></button>
          </div>
          <div class="pw-hint">Mín. 8 caracteres. Mejor con mayúscula, minúscula, número y símbolo.</div>
        </div>

        <button id="loginBtn" type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-sign-in-alt"></i> Iniciar sesión</button>
      </form>

      <div class="divider"></div>
      <div class="oauth-row">
        <button id="googleBtn" class="oauth-btn" onclick="Auth.handleOAuth('google')" style="display:none"><i class="fab fa-google"></i> Google</button>
        <button id="appleBtn" class="oauth-btn" onclick="Auth.handleOAuth('apple')" style="display:none"><i class="fab fa-apple"></i> Apple</button>
      </div>
      
      <div style="margin-top:var(--space)">
        <button class="btn btn-secondary" style="width:100%" onclick="Guest.enter()"><i class="fas fa-eye"></i> Explorar como invitado</button>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:var(--space)">
        <button class="btn-text" onclick="Views.show('resetView')">¿Olvidaste la contraseña?</button>
        <button class="btn-text" onclick="Views.show('signupView')">Crear cuenta</button>
      </div>
    </div>

    <!-- SIGNUP -->
    <div id="signupView" style="display:none">
      <form onsubmit="Auth.handleSignup(event)">
        <div class="grid-2">
          <div class="form-group"><label class="form-label">Nombre completo</label><input id="signupName" class="form-input" placeholder="Tu nombre y apellidos"></div>
          <div class="form-group"><label class="form-label">Zona</label>
            <select id="signupZone" class="form-select">
              <option value="">Selecciona tu zona</option>
              <option value="centro">Centro</option><option value="norte">Norte</option><option value="sur">Sur</option><option value="este">Este</option><option value="oeste">Oeste</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label class="form-label">Correo electrónico</label><input id="signupEmail" type="email" class="form-input" placeholder="tucorreo@dominio.com"></div>

        <div class="form-group">
          <label class="form-label">Contraseña</label>
          <div class="password-wrap">
            <input id="signupPassword" type="password" class="form-input" autocomplete="new-password" placeholder="********">
            <button type="button" class="toggle-eye" onclick="PasswordUI.toggle('signupPassword', this)"><i class="far fa-eye"></i></button>
          </div>
          <ul id="signupPwRules" class="pw-checklist">
            <li><i class="far fa-circle"></i> 8+ caracteres</li>
            <li><i class="far fa-circle"></i> Una mayúscula</li>
            <li><i class="far fa-circle"></i> Una minúscula</li>
            <li><i class="far fa-circle"></i> Un número</li>
            <li><i class="far fa-circle"></i> Un símbolo</li>
          </ul>
        </div>

        <div class="form-group">
          <label class="form-label">Repite la contraseña</label>
          <div class="password-wrap">
            <input id="signupConfirm" type="password" class="form-input" autocomplete="new-password" placeholder="********">
            <button type="button" class="toggle-eye" onclick="PasswordUI.toggle('signupConfirm', this)"><i class="far fa-eye"></i></button>
          </div>
        </div>

        <button id="signupBtn" type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-user-plus"></i> Crear cuenta</button>
      </form>
      <div style="text-align:center;margin-top:var(--space)"><button class="btn-text" onclick="Views.show('loginView')">Volver</button></div>
    </div>

    <!-- RESET -->
    <div id="resetView" style="display:none">
      <form onsubmit="Auth.handleReset(event)">
        <div class="form-group"><label class="form-label">Correo electrónico</label><input id="resetEmail" type="email" class="form-input" placeholder="tucorreo@dominio.com"></div>
        <button id="resetBtn" type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-envelope"></i> Enviar correo de recuperación</button>
      </form>
      <div style="text-align:center;margin-top:var(--space)"><button class="btn-text" onclick="Views.show('loginView')">Volver</button></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app-container" style="display:none">
  <header class="app-header">
    <div class="logo"><i class="fas fa-map-marker-alt"></i><span>ILM</span></div>
    <div class="header-actions">
      <div class="points"><i class="fas fa-coins"></i> <span id="userPoints">0</span></div>
      <button class="notification-btn" onclick="UI.showNotifications()" title="Notificaciones"><i class="fas fa-bell"></i></button>
      <button class="profile-btn" onclick="Auth.handleLogout()" title="Cerrar sesión"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <nav class="nav-tabs">
    <button class="nav-tab active" data-tab="matches" onclick="UI.showTab('matches')"><i class="fas fa-heart"></i><span>Matches</span></button>
    <button class="nav-tab" data-tab="library" onclick="UI.showTab('library')"><i class="fas fa-book"></i><span>Biblioteca</span></button>
    <button class="nav-tab" data-tab="community" onclick="UI.showTab('community')"><i class="fas fa-users"></i><span>Comunidad</span></button>
    <button class="nav-tab" data-tab="profile" onclick="UI.showTab('profile')"><i class="fas fa-user"></i><span>Perfil</span></button>
  </nav>

  <main class="main-content">
    <section id="matches" class="page active">
      <h3 style="margin:.25rem 0 var(--space)">Matches Disponibles</h3>
      
      <!-- Guest signup button -->
      <button id="guestSignupMatches" class="btn btn-primary" style="width:100%;margin-bottom:.75rem;display:none" onclick="Guest.goToSignup()">
        <i class="fas fa-user-plus"></i> Crear cuenta para intercambiar libros
      </button>
      
      <section id="weeklyClub" class="card" style="margin-bottom:.75rem">
        <div class="row">
          <div>
            <div class="badge">Club de lectura de la semana</div>
            <div id="weeklyClubTitle" style="font-weight:600; margin-top:.25rem">Cargando…</div>
            <div id="weeklyClubBook" class="hint">—</div>
            <div id="weeklyClubDates" class="hint">—</div>
          </div>
          <div id="weeklyClubBtnContainer" style="display:flex;gap:.5rem;">
            <button class="btn btn-primary" id="weeklyJoinBtn" disabled>Unirme en Threema</button>
          </div>
        </div>
      </section>
      
      <div id="matchContainer" class="books-grid">
        <div class="empty"><i class="fas fa-book-reader"></i><div>Cargando matches...</div></div>
      </div>
    </section>

    <section id="library" class="page">
      <h3 style="margin:.25rem 0 var(--space)">Mi Biblioteca</h3>
      
      <!-- Guest signup button -->
      <button id="guestSignupLibrary" class="btn btn-primary" style="width:100%;margin-bottom:.75rem;display:none" onclick="Guest.goToSignup()">
        <i class="fas fa-user-plus"></i> Crear cuenta para añadir tus libros
      </button>
      
      <!-- Demo add book button for guests -->
      <button id="guestDemoAddBook" class="btn btn-secondary" style="width:100%;margin-bottom:.75rem;display:none" onclick="Guest.openDemoAddBook()">
        <i class="fas fa-eye"></i> Ver cómo añadir un libro (Demo)
      </button>
      
      <!-- Regular add book button for users -->
      <button id="userAddBookBtn" class="btn btn-primary" style="width:100%;margin-bottom:.75rem" onclick="Modals.openAddBook()">
        <i class="fas fa-plus"></i> Añadir libro
      </button>
      
      <section id="weeklyClubLibrary" class="card" style="margin-bottom:.75rem">
        <div class="row">
          <div>
            <div class="badge">Club de lectura de la semana</div>
            <div id="weeklyClubTitleLib" style="font-weight:600; margin-top:.25rem">Cargando…</div>
            <div id="weeklyClubBookLib" class="hint">—</div>
            <div id="weeklyClubDatesLib" class="hint">—</div>
          </div>
          <div id="weeklyClubBtnContainerLib" style="display:flex;gap:.5rem;">
            <button class="btn btn-primary" id="weeklyJoinBtnLib" disabled>Unirme en Threema</button>
          </div>
        </div>
      </section>
      
      <div id="libraryGrid" class="books-grid">
        <div class="empty"><i class="fas fa-book"></i><div>Cargando biblioteca...</div></div>
      </div>
    </section>

    <!-- SECCIÓN DE COMUNIDAD -->
    <section id="community" class="page">
      <h3 style="margin:.25rem 0 var(--space)">Comunidad de Aprendizaje</h3>
      
      <!-- Discovery Card Adaptativo -->
      <div id="discoveryCard" class="card" style="margin-bottom:1rem;">
        <!-- Contenido dinámico -->
        <div class="row">
          <div style="display:flex;align-items:center;gap:12px">
            <i class="fas fa-compass" style="font-size:2rem;color:var(--primary-wood)"></i>
            <div>
              <div style="font-weight:700">Cargando...</div>
              <div class="hint">Preparando tu experiencia</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Club de la Semana Destacado -->
      <section id="weeklyClubCommunity" class="card" style="margin-bottom:1rem;border:2px solid var(--primary-wood)">
        <div class="row">
          <div>
            <div class="badge" style="background:var(--primary-wood);color:#fff">🏆 Club de la Semana</div>
            <div id="weeklyClubTitleCom" style="font-weight:700;margin-top:.5rem;color:var(--primary-wood)">Semana del thriller</div>
            <div id="weeklyClubBookCom" class="hint">Libro actual: La chica del tren</div>
            <div id="weeklyClubDatesCom" class="hint">Reuniones: Domingo 18:00 • 47 participantes</div>
          </div>
          <div style="display:flex;gap:.5rem;flex-direction:column">
            <button class="btn btn-primary" id="weeklyJoinBtnCom" onclick="joinWeeklyClub()">
              Unirme en Threema
            </button>
            <button class="btn btn-secondary" onclick="InterestDiscovery.showGroupDetails('weekly')">
              Ver Detalles
            </button>
          </div>
        </div>
      </section>

      <!-- Mis Grupos -->
      <div id="myGroupsSection" style="display:none">
        <h4 style="margin:1rem 0 .5rem">Mis Grupos de Interés</h4>
        <div id="myGroupsList" class="groups-grid"></div>
      </div>

      <!-- Grupos Disponibles -->
      <h4 style="margin:1rem 0 .5rem">Grupos Temáticos Disponibles</h4>
      <div id="availableGroupsList" class="groups-grid">
        <div class="empty"><i class="fas fa-users"></i><div>Cargando grupos...</div></div>
      </div>

      <!-- Intercambios -->
      <h4 style="margin:1.5rem 0 .5rem">Intercambios en Tu Comunidad</h4>
      <div id="exchangeList">
        <div class="empty"><i class="fas fa-handshake"></i><div>Cargando intercambios...</div></div>
      </div>
    </section>

    <section id="profile" class="page">
      <h3 style="margin:.25rem 0 var(--space)">Mi Perfil</h3>
      <div id="profileContent">
        <div class="empty"><i class="fas fa-user"></i><div>Cargando perfil...</div></div>
      </div>
      
      <div id="pinterestCard" class="card" style="margin-top:var(--space)">
        <div class="row">
          <div style="display:flex;align-items:center;gap:12px">
            <i class="fab fa-pinterest" style="font-size:1.4rem"></i>
            <div>
              <div style="font-weight:600">Canal de Pinterest</div>
              <div class="hint">Inspiración, portadas y novedades de Interlibros Madrid</div>
            </div>
          </div>
          <a class="btn btn-secondary" href="https://es.pinterest.com/interlibrosmad/" target="_blank" rel="noopener">Visitar</a>
        </div>
      </div>
    
      <h3 style="margin:1.25rem 0 .5rem">Historial de intercambios</h3>
      <div id="profileHistory">
        <div class="empty">
          <i class="fas fa-handshake"></i>
          <div>Aún no tienes intercambios completados</div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Add Book Modal -->
<div id="addBookModal" class="modal">
  <div class="modal-card">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Añadir Libro</h3>
      <button class="close" onclick="Modals.close('addBookModal')">×</button>
    </div>
    <div>
      <div class="form-group"><label class="form-label">Título</label><input id="bookTitle" class="form-input" placeholder="Ej. El puente donde habitan las mariposas"></div>
      <div class="form-group"><label class="form-label">Autor</label><input id="bookAuthor" class="form-input" placeholder="Ej. Nazareth Castellanos"></div>

      <div class="grid-2">
        <div class="form-group"><label class="form-label">ISBN (opcional)</label><input id="bookISBN" class="form-input" placeholder="Ej. 978-84-123456-7-8"></div>
        <div class="form-group">
          <label class="form-label">Género</label>
          <select id="bookGenre" class="form-select">
            <option value="">Selecciona</option>
            <option value="ficcion">Ficción</option><option value="no-ficcion">No ficción</option>
            <option value="fantasia">Fantasía</option><option value="ciencia-ficcion">Ciencia ficción</option>
            <option value="misterio">Misterio</option><option value="romance">Romance</option>
            <option value="historia">Historia</option><option value="biografia">Biografía</option>
            <option value="crecimiento-personal">Crecimiento personal</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Estado</label>
        <select id="bookCondition" class="form-select">
          <option value="">Selecciona</option>
          <option value="nuevo">Nuevo</option><option value="excelente">Excelente</option>
          <option value="bueno">Bueno</option><option value="aceptable">Ver descripción</option>
        </select>
      </div>

      <div class="form-group"><label class="form-label"><i class="fas fa-file-alt"></i> Estado interno (páginas)</label>
        <textarea id="bookInternal" class="form-textarea" placeholder="Sin subrayados, esquinas con leve desgaste..."></textarea>
      </div>

      <div class="form-group"><label class="form-label">Descripción (opcional)</label>
        <textarea id="bookDesc" class="form-textarea" placeholder="Detalles extra o qué buscas a cambio"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-camera"></i> Fotos del libro <span class="hint">(La Cubierta es obligatoria)</span></label>
        <div class="uploader-grid">
          <!-- Cubierta -->
          <div class="upload-card required" id="up_front">
            <div class="preview" id="preview_front"></div>
            <div class="upload-content">
              <div style="font-weight:700"><i class="fas fa-book"></i> Cubierta</div>
              <div class="hint">Toca para subir</div>
            </div>
            <input type="file" accept="image/*" id="file_front" required>
            <button class="remove" type="button" title="Quitar" onclick="event.stopPropagation(); ImageUploader.clear('front')" style="display:none">×</button>
            <span class="overlay">Obligatoria</span>
          </div>

          <!-- Contracubierta -->
          <div class="upload-card" id="up_back">
            <div class="preview" id="preview_back"></div>
            <div class="upload-content">
              <div style="font-weight:700"><i class="fas fa-book-open"></i> Contracubierta</div>
              <div class="hint">Opcional</div>
            </div>
            <input type="file" accept="image/*" id="file_back">
            <button class="remove" type="button" title="Quitar" onclick="event.stopPropagation(); ImageUploader.clear('back')" style="display:none">×</button>
          </div>

          <!-- Lomo -->
          <div class="upload-card" id="up_spine">
            <div class="preview" id="preview_spine"></div>
            <div class="upload-content">
              <div style="font-weight:700"><i class="fas fa-grip-lines-vertical"></i> Lomo</div>
              <div class="hint">Opcional</div>
            </div>
            <input type="file" accept="image/*" id="file_spine">
            <button class="remove" type="button" title="Quitar" onclick="event.stopPropagation(); ImageUploader.clear('spine')" style="display:none">×</button>
          </div>

          <!-- Páginas -->
          <div class="upload-card" id="up_pages">
            <div class="preview" id="preview_pages"></div>
            <div class="upload-content">
              <div style="font-weight:700"><i class="fas fa-file-image"></i> Páginas</div>
              <div class="hint">Opcional</div>
            </div>
            <input type="file" accept="image/*" id="file_pages" multiple>
            <button class="remove" type="button" title="Quitar" onclick="event.stopPropagation(); ImageUploader.clear('pages')" style="display:none">×</button>
          </div>
        </div>
      </div>

      <button id="saveBookBtn" class="btn btn-primary" style="width:100%" onclick="Books.save()"><i class="fas fa-save"></i> Guardar libro</button>
    </div>
  </div>
</div>

<!-- Book Details Modal -->
<div id="bookDetailsModal" class="modal">
  <div class="modal-card">
    <div class="modal-header"><h3 id="bookDetailsTitle">Detalles del libro</h3><button class="close" onclick="Modals.close('bookDetailsModal')">×</button></div>
    <div id="bookDetailsBody"></div>
  </div>
</div>

<!-- Threema Config Modal -->
<div id="threemaConfigModal" class="modal">
  <div class="modal-card">
    <div class="modal-header"><h3><i class="fas fa-message"></i> Configurar Threema</h3><button class="close" onclick="Modals.close('threemaConfigModal')">×</button></div>
    <div>
      <div class="form-group"><label class="form-label">ID de Threema</label><input id="threemaId" class="form-input" placeholder="TU_ID" maxlength="8" style="text-transform:uppercase"></div>
      <div class="grid-2">
        <label class="form-label"><input type="checkbox" id="notifyMatches" checked> Avisos de matches</label>
        <label class="form-label"><input type="checkbox" id="notifyExchanges" checked> Avisos de intercambios</label>
      </div>
      <div class="form-group"><label class="form-label"><input type="checkbox" id="notifyMessages" checked> Avisos de mensajes</label></div>
      <div class="hint" style="margin-bottom:1rem">
        <i class="fas fa-info-circle"></i> Para encontrar tu ID: abre Threema > Mi ID
      </div>
      <button id="saveThreemaBtn" class="btn btn-primary" style="width:100%" onclick="Threema.saveConfig()"><i class="fas fa-save"></i> Guardar</button>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
  <div class="modal-card">
    <div class="modal-header"><h3><i class="fas fa-user-edit"></i> Editar perfil</h3><button class="close" onclick="Modals.close('editProfileModal')">×</button></div>
    <div>
      <div class="form-group"><label class="form-label">Nombre completo</label><input id="editFullName" class="form-input"></div>
      <div class="form-group"><label class="form-label">Zona</label>
        <select id="editZone" class="form-select">
          <option value="centro">Centro</option><option value="norte">Norte</option><option value="sur">Sur</option><option value="este">Este</option><option value="oeste">Oeste</option>
        </select>
      </div>
      <button id="saveProfileBtn" class="btn btn-primary" style="width:100%" onclick="Profile.saveEdit()"><i class="fas fa-save"></i> Guardar cambios</button>
    </div>
  </div>
</div>

<!-- Password Reset Modal -->
<div id="passwordResetModal" class="modal">
  <div class="modal-card">
    <div class="modal-header"><h3><i class="fas fa-key"></i> Cambiar contraseña</h3>
      <button class="close" onclick="Modals.close('passwordResetModal')">×</button>
    </div>
    <form onsubmit="Auth.saveNewPassword(event)">
      <div class="form-group">
        <label class="form-label">Nueva contraseña</label>
        <div class="password-wrap">
          <input id="newPassword" type="password" class="form-input" placeholder="********" autocomplete="new-password">
          <button type="button" class="toggle-eye" onclick="PasswordUI.toggle('newPassword', this)"><i class="far fa-eye"></i></button>
        </div>
        <ul id="resetPwRules" class="pw-checklist">
          <li><i class="far fa-circle"></i> 8+ caracteres</li>
          <li><i class="far fa-circle"></i> Una mayúscula</li>
          <li><i class="far fa-circle"></i> Una minúscula</li>
          <li><i class="far fa-circle"></i> Un número</li>
          <li><i class="far fa-circle"></i> Un símbolo</li>
        </ul>
      </div>
      <div class="form-group">
        <label class="form-label">Repite la contraseña</label>
        <div class="password-wrap">
          <input id="confirmPassword" type="password" class="form-input" placeholder="********" autocomplete="new-password">
          <button type="button" class="toggle-eye" onclick="PasswordUI.toggle('confirmPassword', this)"><i class="far fa-eye"></i></button>
        </div>
      </div>
      <button id="saveNewPasswordBtn" type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-save"></i> Guardar nueva contraseña</button>
    </form>
  </div>
</div>

<!-- Exchange Modal -->
<!-- Exchange / Loan Modal -->
<div id="exchangeModal" class="modal">
  <div class="modal-card">
    <div class="modal-header">
      <h3><i class="fas fa-handshake"></i> Proponer transacción</h3>
      <button class="close" onclick="Modals.close('exchangeModal')">×</button>
    </div>

    <div>
      <div class="form-group">
        <label class="form-label">Tipo de transacción</label>
        <div class="transaction-type-selector" style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;background:var(--primary-pale);padding:.25rem;border-radius:12px">
          <button class="transaction-type-option active" onclick="selectTransactionType('exchange')">
            <i class="fas fa-exchange-alt"></i> Intercambio
          </button>
          <button class="transaction-type-option" onclick="selectTransactionType('loan')">
            <i class="fas fa-clock"></i> Préstamo
          </button>
        </div>
      </div>

      <div id="loanDurationSection" class="loan-duration-selector" style="display:none;background:var(--primary-pale);border-radius:12px;padding:1rem;margin-bottom:1rem">
        <label class="form-label"><i class="fas fa-calendar-alt"></i> Duración del préstamo</label>
        <div class="duration-options" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem;margin-bottom:1rem">
          <div class="duration-option" onclick="selectDuration(7)">1 semana<br><small>7 días</small></div>
          <div class="duration-option selected" onclick="selectDuration(15)">2 semanas<br><small>15 días</small></div>
          <div class="duration-option" onclick="selectDuration(30)">1 mes<br><small>30 días</small></div>
          <div class="duration-option" onclick="selectDuration(45)">6 semanas<br><small>45 días</small></div>
        </div>
        <div class="custom-duration" style="display:flex;gap:.5rem;align-items:center">
          <label style="flex:1">
            <span class="form-label">Duración personalizada (días)</span>
            <input type="number" class="form-input" id="customDurationDays" min="1" max="365" placeholder="Ej. 21" onchange="selectCustomDuration()">
          </label>
          <div style="padding-top:1.5rem">
            <i class="fas fa-info-circle" style="color:var(--text-hint)"></i>
          </div>
        </div>
        <div id="loanInfoBox" class="loan-info-box" style="background:var(--success);color:#fff;padding:.75rem;border-radius:10px;margin-top:.5rem;font-size:.9rem;display:flex;gap:.5rem;align-items:center">
          <i class="fas fa-info-circle"></i>
          <span>Préstamo por <strong>15 días</strong>. Devuelve antes del <strong id="returnDate"></strong>.</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" id="offerBookLabel">Tu libro para intercambiar</label>
        <select id="offerBookSelect" class="form-select"></select>
      </div>

      <div class="form-group">
        <label class="form-label">Mensaje (opcional)</label>
        <textarea id="exchangeNote" class="form-textarea" placeholder="Hola, me interesa tu libro..."></textarea>
      </div>

      <div class="grid-2">
        <div class="form-group"><label class="form-label">Lugar (opcional)</label><input id="exchangePlace" class="form-input" placeholder="Metro Sol, cafetería..."></div>
        <div class="form-group"><label class="form-label">Fecha y hora (opcional)</label><input id="exchangeTime" type="datetime-local" class="form-input"></div>
      </div>

      <button id="createExchangeBtn" class="btn btn-primary" style="width:100%" onclick="Exchange.create()">
        <i class="fas fa-paper-plane"></i> <span id="submitButtonText">Enviar propuesta de intercambio</span>
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE DESCUBRIMIENTO DE INTERESES -->
<div id="interestDiscoveryModal" class="modal">
  <div class="modal-card" style="max-width:700px">
    <div class="modal-header">
      <h3><i class="fas fa-compass"></i> Encuentra Tu Tribu de Aprendizaje</h3>
      <button class="close" onclick="Modals.close('interestDiscoveryModal')">×</button>
    </div>
    
    <div class="discovery-content">
      <div class="intro-section" style="text-align:center;margin-bottom:2rem">
        <div style="font-size:3rem;margin-bottom:1rem">🌟</div>
        <h4>¿Sobre qué te gustaría aprender o encontrar personas afines?</h4>
        <p style="margin-top:1rem;color:var(--text-secondary)">
          ¿Te gusta la Historia, el Thriller, la Cocina, la Permacultura...? 
          <br>¿Qué te mueve a investigar sobre un tema o a seguir leyendo un libro sobre algo que te atrae?
        </p>
      </div>

      <!-- Categorías de Intereses -->
      <div class="interest-categories">
        <div class="category-section">
          <h5 style="display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem">
            <i class="fas fa-theater-masks"></i> Géneros que Te Atrapan
          </h5>
          <div class="interest-tags">
            <button class="interest-tag" data-interest="thriller">Thriller y Misterio</button>
            <button class="interest-tag" data-interest="historia">Historia y Civilizaciones</button>
            <button class="interest-tag" data-interest="ciencia-ficcion">Ciencia Ficción</button>
            <button class="interest-tag" data-interest="novela-negra">Novela Negra</button>
            <button class="interest-tag" data-interest="biografias">Biografías Inspiradoras</button>
            <button class="interest-tag" data-interest="filosofia">Filosofía y Pensamiento</button>
            <button class="interest-tag" data-interest="poesia">Poesía y Literatura</button>
          </div>
        </div>

        <div class="category-section">
          <h5 style="display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem">
            <i class="fas fa-seedling"></i> Aprendizajes Prácticos
          </h5>
          <div class="interest-tags">
            <button class="interest-tag" data-interest="permacultura">Permacultura y Sostenibilidad</button>
            <button class="interest-tag" data-interest="cocina">Cocina y Gastronomía</button>
            <button class="interest-tag" data-interest="jardineria">Jardinería Urbana</button>
            <button class="interest-tag" data-interest="artesania">Artesanía y Oficios</button>
            <button class="interest-tag" data-interest="psicologia">Psicología Humana</button>
            <button class="interest-tag" data-interest="tecnologia">Tecnología y Futuro</button>
            <button class="interest-tag" data-interest="arte">Arte y Creatividad</button>
            <button class="interest-tag" data-interest="idiomas">Idiomas y Culturas</button>
          </div>
        </div>

        <div class="category-section">
          <h5 style="display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem">
            <i class="fas fa-landmark"></i> Raíces y Territorio
          </h5>
          <div class="interest-tags">
            <button class="interest-tag" data-interest="madrid-historia">Historia de Madrid</button>
            <button class="interest-tag" data-interest="autores-locales">Autores de Nuestra Tierra</button>
            <button class="interest-tag" data-interest="cultura-española">Cultura y Tradiciones</button>
            <button class="interest-tag" data-interest="arquitectura">Arquitectura y Urbanismo</button>
            <button class="interest-tag" data-interest="gastronomia-local">Gastronomía Regional</button>
          </div>
        </div>
      </div>

      <!-- Inquietudes Personales -->
      <div class="custom-interests" style="margin-top:2rem">
        <h5 style="display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem">
          <i class="fas fa-lightbulb"></i> ¿Algún otro tema que te inquieta o fascina?
        </h5>
        <textarea id="customInquiries" class="form-textarea" 
                  placeholder="Ej: La arquitectura romana, el budismo tibetano, la fermentación, la astronomía...
¿Qué te despierta curiosidad y ganas de profundizar?"></textarea>
      </div>

      <!-- Motivaciones -->
      <div class="learning-motivations" style="margin-top:2rem">
        <h5 style="margin-bottom:1rem">🤔 ¿Qué te motiva a aprender y compartir?</h5>
        <div class="motivation-grid">
          <label class="motivation-card">
            <input type="checkbox" value="debate">
            <div class="card-content">
              <i class="fas fa-comments" style="font-size:1.5rem;color:var(--primary-wood);margin-bottom:.5rem"></i>
              <h6>Debate y Reflexión</h6>
              <p>Me gusta intercambiar ideas y ver diferentes perspectivas</p>
            </div>
          </label>
          
          <label class="motivation-card">
            <input type="checkbox" value="practica">
            <div class="card-content">
              <i class="fas fa-tools" style="font-size:1.5rem;color:var(--primary-wood);margin-bottom:.5rem"></i>
              <h6>Aprendizaje Práctico</h6>
              <p>Busco conocimientos que pueda aplicar en mi vida</p>
            </div>
          </label>
          
          <label class="motivation-card">
            <input type="checkbox" value="conexion">
            <div class="card-content">
              <i class="fas fa-heart" style="font-size:1.5rem;color:var(--primary-wood);margin-bottom:.5rem"></i>
              <h6>Conexión Humana</h6>
              <p>Quiero encontrar personas con mis mismas pasiones</p>
            </div>
          </label>
          
          <label class="motivation-card">
            <input type="checkbox" value="descubrimiento">
            <div class="card-content">
              <i class="fas fa-search" style="font-size:1.5rem;color:var(--primary-wood);margin-bottom:.5rem"></i>
              <h6>Descubrimiento</h6>
              <p>Me emociona descubrir autores y temas nuevos</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Pregunta Profunda -->
      <div class="deep-question" style="margin-top:2rem">
        <h5 style="margin-bottom:.75rem">🎯 ¿Hay algún tema sobre el que te gustaría saber más pero no sabes por dónde empezar?</h5>
        <textarea id="learningBarriers" class="form-textarea" 
                  placeholder="Ej: 'Siempre me ha fascinado la historia del flamenco pero no sé qué libros leer'
                               'Me interesa la meditación pero todos los libros me parecen muy abstractos'"></textarea>
      </div>

      <button class="btn btn-primary" style="width:100%;margin-top:2rem" onclick="InterestDiscovery.processInterests()">
        <i class="fas fa-magic"></i> Encontrar Mi Comunidad de Aprendizaje
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE RESULTADOS -->
<div id="interestResultsModal" class="modal">
  <div class="modal-card" style="max-width:600px">
    <div class="modal-header">
      <h3><i class="fas fa-heart"></i> Tu Comunidad Te Está Esperando</h3>
      <button class="close" onclick="Modals.close('interestResultsModal')">×</button>
    </div>
    <div id="interestResultsContent">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" class="modal">
  <div class="modal-card">
    <div class="modal-header">
      <h3><i class="fas fa-users-cog"></i> Crear Nuevo Grupo</h3>
      <button class="close" onclick="Modals.close('createGroupModal')">×</button>
    </div>
    <div class="group-creation-form">
      <div class="form-group">
        <label class="form-label">Nombre del grupo</label>
        <input id="groupName" class="form-input" placeholder="Ej. Amantes de la Ciencia Ficción">
      </div>
      
      <div class="form-group">
        <label class="form-label">Descripción</label>
        <textarea id="groupDescription" class="form-textarea" placeholder="Describe de qué tratará tu grupo y qué tipo de personas buscas..."></textarea>
      </div>
      
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">Categoría</label>
          <select id="groupCategory" class="form-select">
            <option value="">Selecciona una categoría</option>
            <option value="literatura">Literatura y Géneros</option>
            <option value="practica">Aprendizaje Práctico</option>
            <option value="cultura">Cultura y Territorio</option>
            <option value="ciencia">Ciencia y Tecnología</option>
            <option value="arte">Arte y Creatividad</option>
            <option value="filosofia">Filosofía y Pensamiento</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tipo de reuniones</label>
          <select id="groupMeetingType" class="form-select">
            <option value="virtual">Solo virtuales</option>
            <option value="presencial">Solo presenciales</option>
            <option value="mixto">Virtuales y presenciales</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Frecuencia aproximada</label>
        <select id="groupFrequency" class="form-select">
          <option value="semanal">Semanal</option>
          <option value="quincenal">Quincenal</option>
          <option value="mensual">Mensual</option>
          <option value="flexible">Flexible según disponibilidad</option>
        </select>
      </div>
      
      <button id="createGroupBtn" class="btn btn-primary" style="width:100%" onclick="InterestDiscovery.submitGroupCreation()">
        <i class="fas fa-plus-circle"></i> Crear Grupo
      </button>
    </div>
  </div>
</div>

<!-- Group Activity Modal -->
<div id="groupActivityModal" class="modal">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="groupActivityTitle"><i class="fas fa-chart-line"></i> Actividad del Grupo</h3>
      <button class="close" onclick="Modals.close('groupActivityModal')">×</button>
    </div>
    <div id="groupActivityContent">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = "SUPABASE_URL";
const SUPABASE_ANON_KEY = "SUPABASE_ANON_KEY";
const SOCIAL_LOGIN_ENABLED = { google: true, apple: true };
const BUCKET = 'books';
const PUBLIC_READ = true;
const GUEST_USE_DB = true;
const TRADE_EXPIRY_DAYS = 7;

// Global variables
let supabaseClient = null;
let currentUser = null;
let userBooks = [];
let matches = [];
let didBootstrap = false;

// Weekly club message
const WEEKLY_CLUB_MESSAGE = "Semana del thriller: Capítulos 1-5. Primera reunión virtual mañana 20:00. ¡Ya somos 47 participantes!";

// Configuration check
const isConfigured = () => {
  return SUPABASE_URL !== "SUPABASE_URL_PLACEHOLDER" && 
         SUPABASE_ANON_KEY !== "SUPABASE_ANON_KEY_PLACEHOLDER" &&
         SUPABASE_URL.startsWith('https://') &&
         SUPABASE_ANON_KEY.length > 50;
};

// Helper functions
function toggleAuthViews(loggedIn) {
  const authEl = document.getElementById('auth');
  const appEl = document.getElementById('app');
  if (authEl) authEl.style.display = loggedIn ? 'none' : 'grid';
  if (appEl) appEl.style.display = loggedIn ? 'block' : 'none';
}

async function bootstrapAfterLogin() {
  if (didBootstrap) return;
  didBootstrap = true;
  
  // IMPORTANTE: Asegurar que el modo invitado está desactivado
  if (window.Guest && Guest.isGuest) {
    console.log('Fixing guest mode after login');
    Guest.checkAndFixState();
  }
  
  try {
    console.log('Bootstrapping user session...');
    await Profile.load();
    await Books.loadMine();
    await Matches.load();
    await loadWeeklyClub();
    await loadWeeklyClubLibrary();
    UI.showTab('matches');
    console.log('Bootstrap completed successfully');
  } catch (e) {
    console.warn('Bootstrap error:', e);
  }
}

// Initialize Supabase
function initializeSupabase() {
  try {
    if (!isConfigured()) {
      console.warn('Supabase configuration missing or invalid');
      return false;
    }
    
    if (!window.supabase) {
      console.error('Supabase library not loaded');
      return false;
    }
    
    supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      }
    );
    return true;
  } catch (error) {
    console.error('Failed to initialize Supabase:', error);
    return false;
  }
}

// Auth state management
async function setupAuthStateListener() {
  if (!supabaseClient) return;
  
  try {
    const { data: { session } } = await supabaseClient.auth.getSession();
    currentUser = session?.user || null;
    toggleAuthViews(!!currentUser);
    
    if (currentUser) {
      await bootstrapAfterLogin();
    }

    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      currentUser = session?.user || null;

      if (event === 'PASSWORD_RECOVERY') {
        Auth._recovery = true;
        toggleAuthViews(false);
        Auth.showPasswordResetModal();
        return;
      }

      toggleAuthViews(!!currentUser);

      if (currentUser && (
          event === 'SIGNED_IN' ||
          event === 'TOKEN_REFRESHED' ||
          event === 'USER_UPDATED' ||
          event === 'INITIAL_SESSION'
      )) {
        await bootstrapAfterLogin();
      }

      if (!currentUser && event === 'SIGNED_OUT') {
        didBootstrap = false;
      }
    });
  } catch (error) {
    console.error('Auth setup error:', error);
  }
}

const toast = (type, message) => {
  try {
    const notification = document.createElement('div'); 
    notification.className = `toast ${type}`; 
    notification.textContent = message; 
    document.body.appendChild(notification); 
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000); 
  } catch (e) {
    console.error('Toast error:', e);
  }
};

const showNotification = (type, message) => toast(type, message);

// Input validation utilities
const InputSanitizer = {
  sanitizeText: (str) => {
    try {
      return (typeof str === 'string' ? str : '').trim().replace(/[<>"'&]/g, '').slice(0, 1000);
    } catch (e) {
      return '';
    }
  },
  sanitizeEmail: (str) => {
    try {
      return (typeof str === 'string' ? str : '').trim().toLowerCase().replace(/[<>"'&]/g, '').slice(0, 320);
    } catch (e) {
      return '';
    }
  },
  isValidEmail: (str) => {
    try {
      return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(str || '');
    } catch (e) {
      return false;
    }
  }
};

// UI Helper functions
window.Views = { 
  show(id) { 
    try {
      ['loginView','signupView','resetView'].forEach(v => {
        const el = document.getElementById(v);
        if (el) el.style.display = (v === id ? 'block' : 'none');
      }); 
    } catch (e) {
      console.error('Views.show error:', e);
    }
  } 
};

// UI Management
const UI = {
  showTab(id) {
    try {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const targetPage = document.getElementById(id);
      if (targetPage) targetPage.classList.add('active');
      
      document.querySelectorAll('.nav-tab').forEach(b => 
        b.classList.toggle('active', b.dataset.tab === id)
      );
      
      if (id === 'library') {
        if (window.Guest && Guest.isGuest) {
          Guest.loadPublicFeed();
          Guest.showGuestButtons();
        } else {
          Books.loadMine();
        }
        try { loadWeeklyClubLibrary(); } catch(e) {}
      }
      if (id === 'matches') {
        if (window.Guest && Guest.isGuest) {
          Guest.loadPublicFeed();
          Guest.showGuestButtons();
        } else {
          Matches.load();
        }
        try { loadWeeklyClub(); } catch(e) {}
      }
      if (id === 'community') {
        console.log('🏘️ Switching to community tab');
        
        if (window.Exchange) {
          try {
            Exchange.list();
          } catch (e) {
            console.warn('Exchange list failed:', e);
          }
        }
        
        setTimeout(async () => {
          try {
            if (window.CommunityManager) {
              console.log('🚀 Loading adaptive community...');
              await CommunityManager.loadAdaptive();
            } else {
              console.error('⚠️ CommunityManager not available');
              const discoveryCard = document.getElementById('discoveryCard');
              if (discoveryCard) {
                discoveryCard.innerHTML = `
                  <div class="row">
                    <div style="display:flex;align-items:center;gap:12px">
                      <i class="fas fa-users" style="font-size:2rem;color:var(--primary-wood)"></i>
                      <div>
                        <div style="font-weight:700">Comunidad de curiosos</div>
                        <div class="hint">Conecta con otros apasionados del conocimiento</div>
                      </div>
                    </div>
                    <button class="btn btn-primary" onclick="showNotification('info', 'Sistema cargando...')">
                      <i class="fas fa-eye"></i> Explorar
                    </button>
                  </div>`;
              }
            }
          } catch (error) {
            console.error('⚠️ Error loading community:', error);
            
            const discoveryCard = document.getElementById('discoveryCard');
            if (discoveryCard) {
              discoveryCard.innerHTML = `
                <div class="row" style="background:var(--primary-pale);padding:1rem;border-radius:12px;">
                  <div style="display:flex;align-items:center;gap:12px">
                    <i class="fas fa-exclamation-triangle" style="font-size:2rem;color:var(--warning)"></i>
                    <div>
                      <div style="font-weight:700">Comunidad en Desarrollo</div>
                      <div class="hint">Funcionalidades disponibles próximamente</div>
                    </div>
                  </div>
                  <button class="btn btn-secondary" onclick="showNotification('info', 'Función en desarrollo')">
                    <i class="fas fa-info"></i> Info
                  </button>
                </div>`;
            }
            
            const groupsList = document.getElementById('availableGroupsList');
            if (groupsList) {
              groupsList.innerHTML = `
                <div class="empty">
                  <i class="fas fa-users"></i>
                  <div>Sistema de grupos en desarrollo</div>
                  <div class="hint">Próximamente podrás unirte a grupos de lectura</div>
                </div>`;
            }
          }
        }, 100);
      }
      if (id === 'profile' && window.Profile) {
        Profile.load();
        setTimeout(() => Profile.loadHistory(), 500);
      }
    } catch (e) {
      console.error('UI.showTab error:', e);
    }
  },
  showNotifications() { 
    showNotification('info', 'No tienes notificaciones nuevas'); 
  }
};

const Modals = { 
  openAddBook() { 
    try {
      if (!currentUser) {
        showNotification('warning', 'Inicia sesión para añadir libros');
        return;
      }
      
      const modal = document.getElementById('addBookModal');
      if (!modal) {
        console.error('Add book modal not found');
        return;
      }
      
      modal.classList.add('active'); 
      document.body.classList.add('modal-open');
      
      const saveBtn = document.getElementById('saveBookBtn');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar libro';
        saveBtn.onclick = () => Books.save();
      }
      
      const uploadCards = document.querySelectorAll('.upload-card');
      uploadCards.forEach(card => {
        card.style.opacity = '1';
        card.style.pointerEvents = 'auto';
      });
      
      setTimeout(() => {
        ImageUploader.reset();
        ImageUploader.bind();
      }, 100);
      
    } catch (e) {
      console.error('Modals.openAddBook error:', e);
      showNotification('error', 'Error al abrir el modal');
    }
  }, 
  
  close(id) { 
    try {
      const modal = document.getElementById(id);
      if (modal) modal.classList.remove('active'); 
      
      if (!document.querySelector('.modal.active')) {
        document.body.classList.remove('modal-open'); 
      }
      
      if (id === 'addBookModal') {
        ImageUploader.reset();
        
        ['bookTitle', 'bookAuthor', 'bookISBN', 'bookInternal', 'bookDesc'].forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) field.value = '';
        });
        
        ['bookGenre', 'bookCondition'].forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) select.selectedIndex = 0;
        });
        
        const saveBtn = document.getElementById('saveBookBtn');
        if (saveBtn) {
          saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar libro';
          saveBtn.onclick = () => Books.save();
        }
        
        const uploadCards = document.querySelectorAll('.upload-card');
        uploadCards.forEach(card => {
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
          const hint = card.querySelector('.hint');
          const isRequired = card.classList.contains('required');
          if (hint) {
            hint.textContent = isRequired ? 'Toca para subir' : 'Opcional';
          }
        });
      }
      
      // Reset form fields for interest discovery modal
      if (id === 'interestDiscoveryModal') {
        document.querySelectorAll('.interest-tag.selected').forEach(tag => {
          tag.classList.remove('selected');
        });
        document.querySelectorAll('.motivation-card input:checked').forEach(input => {
          input.checked = false;
          input.parentElement.querySelector('.card-content').style.background = '';
        });
        const customInquiries = document.getElementById('customInquiries');
        const learningBarriers = document.getElementById('learningBarriers');
        if (customInquiries) customInquiries.value = '';
        if (learningBarriers) learningBarriers.value = '';
      }
      
      // Reset create group modal
      if (id === 'createGroupModal') {
        ['groupName', 'groupDescription'].forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) field.value = '';
        });
        ['groupCategory', 'groupMeetingType', 'groupFrequency'].forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) select.selectedIndex = 0;
        });
      }
      
    } catch (e) {
      console.error('Modals.close error:', e);
    }
  }
};

/* ===== Password rules/UI ===== */
const PasswordRules = {
  test(pw) { 
    return { 
      len: pw.length >= 8, 
      up: /[A-ZÁÉÍÓÚÜÑ]/.test(pw), 
      lo: /[a-záéíóúñ]/.test(pw), 
      di: /\d/.test(pw), 
      sy: /[^A-Za-z0-9]/.test(pw) 
    }; 
  },
  isStrong(pw) { 
    const t = this.test(pw); 
    return t.len && t.up && t.lo && t.di && t.sy; 
  },
  message(pw) { 
    const t = this.test(pw); 
    if (!t.len) return 'La contraseña debe tener al menos 8 caracteres'; 
    if (!t.up) return 'Añade al menos una mayúscula'; 
    if (!t.lo) return 'Añade al menos una minúscula'; 
    if (!t.di) return 'Añade al menos un número'; 
    if (!t.sy) return 'Añade al menos un símbolo'; 
    return 'La contraseña no cumple los requisitos'; 
  }
};

const PasswordUI = {
  toggle(inputId, btn) {
    const el = document.getElementById(inputId);
    if (!el) return;
    el.type = (el.type === 'password' ? 'text' : 'password');
    const icon = btn.querySelector('i');
    if (icon) {
      icon.className = (el.type === 'password' ? 'far fa-eye' : 'far fa-eye-slash');
    }
  },
  attachChecklist(inputId, listId) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    if (!input || !list) return;
    
    const items = [...list.querySelectorAll('li')];
    const icons = [...list.querySelectorAll('li i')];
    
    const paint = () => {
      const t = PasswordRules.test(input.value);
      [t.len, t.up, t.lo, t.di, t.sy].forEach((v, i) => {
        if (items[i] && icons[i]) {
          items[i].classList.toggle('ok', v);
          icons[i].className = v ? 'fas fa-check-circle' : 'far fa-circle';
        }
      });
    };
    
    input.addEventListener('input', paint);
    paint();
  }
};

/* ===== Authentication ===== */
const Auth = {
  _recovery: false,

  async handleLogin(event) {
    event.preventDefault();
    if (!supabaseClient) {
      showNotification('error', 'Sistema no disponible');
      return;
    }

    const email = InputSanitizer.sanitizeEmail(document.getElementById('loginEmail').value);
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
      showNotification('warning', 'Completa todos los campos');
      return;
    }

    if (!InputSanitizer.isValidEmail(email)) {
      showNotification('warning', 'Email inválido');
      return;
    }

    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';

    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) throw error;

      showNotification('success', '¡Bienvenido de vuelta!');
    } catch (error) {
      console.error('Login error:', error);
      const messages = {
        'Invalid login credentials': 'Email o contraseña incorrectos',
        'Email not confirmed': 'Confirma tu email antes de iniciar sesión'
      };
      showNotification('error', messages[error.message] || 'Error al iniciar sesión');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar sesión';
    }
  },

  async handleSignup(event) {
    event.preventDefault();
    if (!supabaseClient) {
      showNotification('error', 'Sistema no disponible');
      return;
    }

    const name = InputSanitizer.sanitizeText(document.getElementById('signupName').value);
    const email = InputSanitizer.sanitizeEmail(document.getElementById('signupEmail').value);
    const zone = document.getElementById('signupZone').value;
    const password = document.getElementById('signupPassword').value;
    const confirmPw = document.getElementById('signupConfirm').value;

    if (!name || !email || !zone || !password || !confirmPw) {
      showNotification('warning', 'Completa todos los campos');
      return;
    }

    if (!InputSanitizer.isValidEmail(email)) {
      showNotification('warning', 'Email inválido');
      return;
    }

    if (!PasswordRules.isStrong(password)) {
      showNotification('warning', PasswordRules.message(password));
      return;
    }

    if (password !== confirmPw) {
      showNotification('warning', 'Las contraseñas no coinciden');
      return;
    }

    const btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';

    try {
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: name,
            zone: zone
          }
        }
      });

      if (error) throw error;

      if (data.user && !data.session) {
        showNotification('info', 'Revisa tu email para confirmar la cuenta');
        Views.show('loginView');
      } else {
        showNotification('success', '¡Cuenta creada con éxito!');
      }
    } catch (error) {
      console.error('Signup error:', error);
      const messages = {
        'User already registered': 'Este email ya está registrado'
      };
      showNotification('error', messages[error.message] || 'Error al crear la cuenta');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-user-plus"></i> Crear cuenta';
    }
  },

  async handleReset(event) {
    event.preventDefault();
    if (!supabaseClient) {
      showNotification('error', 'Sistema no disponible');
      return;
    }

    const email = InputSanitizer.sanitizeEmail(document.getElementById('resetEmail').value);

    if (!email || !InputSanitizer.isValidEmail(email)) {
      showNotification('warning', 'Introduce un email válido');
      return;
    }

    const btn = document.getElementById('resetBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

    try {
      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin
      });

      if (error) throw error;

      showNotification('success', 'Correo de recuperación enviado');
      Views.show('loginView');
    } catch (error) {
      console.error('Reset error:', error);
      showNotification('error', 'Error al enviar el correo');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-envelope"></i> Enviar correo de recuperación';
    }
  },

  async handleOAuth(provider) {
    if (!supabaseClient) {
      showNotification('error', 'Sistema no disponible');
      return;
    }

    try {
      const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider,
        options: {
          redirectTo: window.location.origin
        }
      });

      if (error) throw error;
    } catch (error) {
      console.error(`${provider} OAuth error:`, error);
      showNotification('error', `Error con ${provider}`);
    }
  },

  async handleLogout() {
    if (!supabaseClient) return;

    try {
      await supabaseClient.auth.signOut();
      showNotification('info', 'Sesión cerrada');
      
      didBootstrap = false;
      userBooks = [];
      matches = [];
      
      if (window.Exchange && Exchange.cleanup) {
        Exchange.cleanup();
      }
      
      toggleAuthViews(false);
      Views.show('loginView');
    } catch (error) {
      console.error('Logout error:', error);
      showNotification('error', 'Error al cerrar sesión');
    }
  },

  showPasswordResetModal() {
    const modal = document.getElementById('passwordResetModal');
    if (modal) {
      modal.classList.add('active');
      document.body.classList.add('modal-open');
      
      setTimeout(() => {
        PasswordUI.attachChecklist('newPassword', 'resetPwRules');
      }, 100);
    }
  },

  async saveNewPassword(event) {
    event.preventDefault();
    if (!supabaseClient) return;

    const password = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;

    if (!password || !confirm) {
      showNotification('warning', 'Completa ambos campos');
      return;
    }

    if (!PasswordRules.isStrong(password)) {
      showNotification('warning', PasswordRules.message(password));
      return;
    }

    if (password !== confirm) {
      showNotification('warning', 'Las contraseñas no coinciden');
      return;
    }

    const btn = document.getElementById('saveNewPasswordBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    try {
      const { error } = await supabaseClient.auth.updateUser({
        password: password
      });

      if (error) throw error;

      showNotification('success', 'Contraseña actualizada correctamente');
      Modals.close('passwordResetModal');
      
      if (this._recovery) {
        this._recovery = false;
        toggleAuthViews(true);
        await bootstrapAfterLogin();
      }
    } catch (error) {
      console.error('Password update error:', error);
      showNotification('error', 'Error al actualizar la contraseña');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Guardar nueva contraseña';
    }
  }
};

/* ===== Threema Integration ===== */
const Threema = {
  config: JSON.parse(localStorage.getItem('threemaConfig') || '{"id":"","notifications":{"matches":true,"exchanges":true,"messages":true},"connected":false}'),
  
  save(v) { 
    this.config = v; 
    localStorage.setItem('threemaConfig', JSON.stringify(v)); 
  },
  
  openConfig() {
    if (!currentUser) {
      showNotification('info', 'Inicia sesión para configurar Threema');
      return;
    }
    
    const threemaIdEl = document.getElementById('threemaId');
    const notifyMatchesEl = document.getElementById('notifyMatches');
    const notifyExchangesEl = document.getElementById('notifyExchanges');
    const notifyMessagesEl = document.getElementById('notifyMessages');
    
    if (threemaIdEl) threemaIdEl.value = this.config.id || '';
    if (notifyMatchesEl) notifyMatchesEl.checked = !!this.config.notifications?.matches;
    if (notifyExchangesEl) notifyExchangesEl.checked = !!this.config.notifications?.exchanges;
    if (notifyMessagesEl) notifyMessagesEl.checked = !!this.config.notifications?.messages;
    
    const modal = document.getElementById('threemaConfigModal');
    if (modal) {
      modal.classList.add('active'); 
      document.body.classList.add('modal-open');
    }
  },
  
  async saveConfig() {
    const idEl = document.getElementById('threemaId');
    const notifyMatchesEl = document.getElementById('notifyMatches');
    const notifyExchangesEl = document.getElementById('notifyExchanges');
    const notifyMessagesEl = document.getElementById('notifyMessages');
    
    const id = (idEl?.value || '').trim().toUpperCase();
    if (id.length !== 8) {
      showNotification('warning', 'Introduce un Threema ID válido (8 caracteres)');
      return;
    }
    
    this.save({ 
      id, 
      notifications: { 
        matches: notifyMatchesEl?.checked || false, 
        exchanges: notifyExchangesEl?.checked || false, 
        messages: notifyMessagesEl?.checked || false 
      }, 
      connected: true 
    });
    
    try {
      if (currentUser && supabaseClient) {
        await supabaseClient
          .from('profiles')
          .update({
            threema_id: id,
            threema_notifications: this.config.notifications
          })
          .eq('id', currentUser.id);
      }
      showNotification('success', 'Threema configurado correctamente');
      Modals.close('threemaConfigModal');
      if (window.Profile) Profile.load();
    } catch (e) {
      console.error('Threema save error:', e);
      showNotification('error', 'No se pudo guardar la configuración');
    }
  },
  
  message(targetId, text) {
    try {
      window.open(`threema://add?id=${encodeURIComponent(targetId)}&text=${encodeURIComponent(text)}`, '_blank');
      showNotification('info', 'Abriendo Threema…');
    } catch (e) {
      console.error('Threema message error:', e);
      showNotification('error', 'No se pudo abrir Threema');
    }
  }
};

/* ===== Image Uploader ===== */
const ImageUploader = {
  files: { front: null, back: null, spine: null, pages: null },
  
  bind() {
    console.log('📷 Initializing ImageUploader...');
    
    this.setupUpload('front', true);
    this.setupUpload('back', false);  
    this.setupUpload('spine', false);
    this.setupUpload('pages', false);
    
    console.log('✅ ImageUploader initialized');
  },
  
  setupUpload(type, required = false) {
    const card = document.getElementById(`up_${type}`);
    const input = document.getElementById(`file_${type}`);
    
    if (!card || !input) {
      console.error(`⚠️ Elements not found for ${type}:`, { card: !!card, input: !!input });
      return;
    }
    
    console.log(`✅ Setting up ${type} upload`);
    
    card.onclick = null;
    input.onchange = null;
    
    card.onclick = (e) => {
      if (e.target.classList.contains('remove')) {
        return;
      }
      
      console.log(`📂 Opening file picker for ${type}`);
      input.click();
    };
    
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      
      if (!file) {
        console.log(`⚠️ No file selected for ${type}`);
        return;
      }
      
      console.log(`📄 File selected for ${type}:`, {
        name: file.name,
        size: file.size,
        type: file.type
      });
      
      if (!file.type.startsWith('image/')) {
        showNotification('warning', 'Solo se permiten archivos de imagen');
        input.value = '';
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showNotification('warning', 'La imagen no puede ser mayor a 5MB');
        input.value = '';
        return;
      }
      
      this.files[type] = file;
      this.showPreview(type, file);
    };
    
    console.log(`✅ ${type} upload ready`);
  },
  
  showPreview(type, file) {
    const card = document.getElementById(`up_${type}`);
    const preview = document.getElementById(`preview_${type}`);
    const removeBtn = card?.querySelector('.remove');
    
    if (!card || !preview) {
      console.error(`⚠️ Preview elements not found for ${type}`);
      return;
    }
    
    console.log(`🖼️ Creating preview for ${type}`);
    
    card.classList.add('has-image');
    if (removeBtn) {
      removeBtn.style.display = 'block';
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.style.backgroundImage = `url(${e.target.result})`;
      preview.style.display = 'block';
      console.log(`✅ Preview set for ${type}`);
    };
    
    reader.onerror = () => {
      console.error(`⚠️ Error reading file for ${type}`);
      showNotification('error', 'Error al leer el archivo');
      this.clear(type);
    };
    
    reader.readAsDataURL(file);
  },
  
  clear(type) {
    console.log(`🗑️ Clearing ${type}`);
    
    this.files[type] = null;
    
    const input = document.getElementById(`file_${type}`);
    if (input) {
      input.value = '';
    }
    
    const card = document.getElementById(`up_${type}`);
    const preview = document.getElementById(`preview_${type}`);
    const removeBtn = card?.querySelector('.remove');
    
    if (card) {
      card.classList.remove('has-image');
    }
    
    if (preview) {
      preview.style.backgroundImage = '';
      preview.style.display = 'none';
    }
    
    if (removeBtn) {
      removeBtn.style.display = 'none';
    }
    
    console.log(`✅ ${type} cleared`);
  },
  
  reset() {
    console.log('🔄 Resetting ImageUploader');
    Object.keys(this.files).forEach(type => this.clear(type));
  },
  
  validate() {
    if (!this.files.front) {
      showNotification('warning', 'La foto de cubierta es obligatoria');
      return false;
    }
    
    if (!this.files.front.type.startsWith('image/')) {
      showNotification('warning', 'La cubierta debe ser una imagen válida');
      return false;
    }
    
    return true;
  }
};

/* ===== Guest mode ===== */
window.Guest = {
  isGuest: false,
  
  async enter() {
    this.isGuest = true;
    toggleAuthViews(true);
    UI.showTab('matches');
    await this.loadPublicFeed();
    
    this.showGuestButtons();
    
    const userAddBtn = document.getElementById('userAddBookBtn');
    if (userAddBtn) userAddBtn.style.display = 'none';
  },
  
  exit() {
    this.isGuest = false;
    this.hideGuestButtons();
    
    const userAddBtn = document.getElementById('userAddBookBtn');
    if (userAddBtn) userAddBtn.style.display = 'block';
    
    loadWeeklyClub();
    loadWeeklyClubLibrary();
    
    toggleAuthViews(false);
    Views.show('loginView');
  },
  
  checkAndFixState() {
    if (this.isGuest && currentUser) {
      console.log('Fixing guest state - user is logged in');
      this.isGuest = false;
      this.hideGuestButtons();
      const userAddBtn = document.getElementById('userAddBookBtn');
      if (userAddBtn) userAddBtn.style.display = 'block';
    }
  },
  
  showGuestButtons() {
    const signupButtons = [
      'guestSignupMatches',
      'guestSignupLibrary', 
      'guestSignupCommunity',
      'guestSignupProfile'
    ];
    
    signupButtons.forEach(buttonId => {
      const btn = document.getElementById(buttonId);
      if (btn) btn.style.display = 'block';
    });
    
    const demoBtn = document.getElementById('guestDemoAddBook');
    if (demoBtn) demoBtn.style.display = 'block';
    
    const userBtn = document.getElementById('userAddBookBtn');
    if (userBtn) userBtn.style.display = 'none';
  },
  
  hideGuestButtons() {
    const allGuestButtons = [
      'guestSignupMatches',
      'guestSignupLibrary',
      'guestSignupCommunity', 
      'guestSignupProfile',
      'guestDemoAddBook'
    ];
    
    allGuestButtons.forEach(buttonId => {
      const btn = document.getElementById(buttonId);
      if (btn) btn.style.display = 'none';
    });
    
    const userBtn = document.getElementById('userAddBookBtn');
    if (userBtn) userBtn.style.display = 'block';
  },
  
  goToSignup() {
    this.exit();
    Views.show('signupView');
  },
  
  openDemoAddBook() {
    const modal = document.getElementById('addBookModal');
    if (!modal) return;
    
    modal.classList.add('active');
    document.body.classList.add('modal-open');
    
    setTimeout(() => {
      document.getElementById('bookTitle').value = 'Cien años de soledad';
      document.getElementById('bookAuthor').value = 'Gabriel García Márquez';
      document.getElementById('bookISBN').value = '978-84-376-0494-7';
      document.getElementById('bookGenre').value = 'ficcion';
      document.getElementById('bookCondition').value = 'excelente';
      document.getElementById('bookInternal').value = 'Páginas en perfecto estado, sin subrayados ni anotaciones';
      document.getElementById('bookDesc').value = 'Edición conmemorativa. Busco libros de realismo mágico o literatura latinoamericana';
      
      const saveBtn = document.getElementById('saveBookBtn');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-user-plus"></i> Crear cuenta para guardar';
        saveBtn.onclick = () => {
          Modals.close('addBookModal');
          Guest.goToSignup();
        };
      }
      
      showNotification('info', 'Modo demo: Crea una cuenta para añadir libros de verdad');
      
      ImageUploader.reset();
      
      const uploadCards = document.querySelectorAll('.upload-card');
      uploadCards.forEach(card => {
        card.style.opacity = '0.7';
        card.style.pointerEvents = 'none';
        const hint = card.querySelector('.hint');
        if (hint) hint.textContent = 'Demo: Las fotos se añaden tras crear cuenta';
      });
    }, 100);
  },
  
  async loadPublicFeed() {
    const matchEl = document.getElementById('matchContainer');
    const libEl = document.getElementById('libraryGrid');
    if (matchEl) matchEl.innerHTML = '<div class="hint">Cargando libros públicos…</div>';
    if (libEl) libEl.innerHTML = '<div class="hint">Cargando libros públicos…</div>';
    
    try {
      if (GUEST_USE_DB && window.supabaseClient) {
        let { data, error } = await supabaseClient
          .from('books_public')
          .select('id,title,author,condition,front_url,created_at')
          .order('created_at', { ascending: false })
          .limit(48);
          
        if (error && /does not exist|relation/i.test(String(error.message || error))) {
          ({ data, error } = await supabaseClient
            .from('books')
            .select('id,title,author,condition,front_url,created_at,is_public')
            .eq('is_public', true)
            .order('created_at', { ascending: false })
            .limit(48));
        }
        
        if (!error && Array.isArray(data) && data.length) {
          const cards = data.map(Books.card).join('');
          if (matchEl) matchEl.innerHTML = cards;
          if (libEl) libEl.innerHTML = cards;
          return;
        }
      }
      
      if (!window.supabaseClient) {
        const placeholder = '<div class="empty"><i class="fas fa-book-reader"></i><div>Aún no hay portadas públicas</div></div>';
        if (matchEl) matchEl.innerHTML = placeholder;
        if (libEl) libEl.innerHTML = placeholder;
        return;
      }
      
      const root = await supabaseClient.storage.from(BUCKET).list('', { limit: 100 });
      const folders = (root.data || []).filter(x => !x.id);
      const items = [];
      
      for (const f of folders) {
        const r = await supabaseClient.storage.from(BUCKET).list(f.name, { limit: 50, sortBy: { column: 'created_at', order: 'desc' } });
        const files = (r.data || []).filter(x => x.id);
        const front = files.find(x => /-front\./i.test(x.name)) || files[0];
        if (!front) continue;
        
        const p = `${f.name}/${front.name}`;
        const { data } = supabaseClient.storage.from(BUCKET).getPublicUrl(p);
        if (data?.publicUrl) {
          items.push({ 
            id: p, 
            title: 'Libro de la comunidad', 
            author: '—', 
            condition: '—', 
            front_url: data.publicUrl 
          });
        }
        if (items.length >= 36) break;
      }
      
      const cards = items.map(Books.card).join('');
      if (matchEl) matchEl.innerHTML = cards || '<div class="empty"><i class="fas fa-book-reader"></i><div>Aún no hay portadas públicas</div></div>';
      if (libEl) libEl.innerHTML = cards || '<div class="empty"><i class="fas fa-book"></i><div>Aún no hay portadas públicas</div></div>';
      
    } catch(e) {
      console.error('Guest feed error', e);
      if (matchEl) matchEl.innerHTML = '<div class="empty">No se pudieron cargar libros públicos</div>';
    }
  }
};

/* ===== Books ===== */
const Books = {
  async save() {
    if (!currentUser || !supabaseClient) {
      showNotification('error', 'No autenticado o sistema no disponible');
      return;
    }
    
    const title = InputSanitizer.sanitizeText(document.getElementById('bookTitle').value);
    const author = InputSanitizer.sanitizeText(document.getElementById('bookAuthor').value);
    const isbn = InputSanitizer.sanitizeText(document.getElementById('bookISBN').value);
    const genre = document.getElementById('bookGenre').value;
    const condition = document.getElementById('bookCondition').value;
    const internal_condition = InputSanitizer.sanitizeText(document.getElementById('bookInternal').value);
    const description = InputSanitizer.sanitizeText(document.getElementById('bookDesc').value);
    
    if (!title || !author || !genre || !condition) {
      showNotification('warning', 'Completa título, autor, género y estado');
      return;
    }
    
    if (!ImageUploader.validate()) {
      return;
    }

    const btn = document.getElementById('saveBookBtn'); 
    btn.disabled = true; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando…';
    
    try {
      console.log('Starting book save process...');
      
      let zone = 'centro';
      try {
        const { data: prof } = await supabaseClient.from('profiles').select('zone').eq('id', currentUser.id).single();
        zone = prof?.zone || 'centro';
      } catch (e) {
        console.warn('Could not get user zone, using default:', e);
      }
      
      const bookId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
      console.log('Generated book ID:', bookId);
      
      let front_url = null, back_url = null, spine_url = null, pages_url = null;
      
      try {
        if (ImageUploader.files.front) {
          front_url = await this.uploadImage('front', ImageUploader.files.front, currentUser.id);
        }
        if (ImageUploader.files.back) {
          back_url = await this.uploadImage('back', ImageUploader.files.back, currentUser.id);
        }
        if (ImageUploader.files.spine) {
          spine_url = await this.uploadImage('spine', ImageUploader.files.spine, currentUser.id);
        }
        if (ImageUploader.files.pages) {
          pages_url = await this.uploadImage('pages', ImageUploader.files.pages, currentUser.id);
        }
      } catch (uploadError) {
        console.error('Image upload error:', uploadError);
        showNotification('error', 'Error al subir las imágenes: ' + uploadError.message);
        return;
      }
      
      console.log('Inserting book into database...');
      const bookData = {
        id: bookId,
        user_id: currentUser.id,
        title,
        author,
        isbn,
        genre,
        condition,
        internal_condition,
        description,
        zone,
        is_available: true,
        front_url,
        back_url,
        spine_url,
        pages_url
      };
      
      console.log('Attempting to insert book data:', bookData);
      
      const { data, error } = await supabaseClient
        .from('books')
        .insert([bookData])
        .select('*')
        .single();

      if (error) {
        console.error('Database insert error:', error);
        console.error('Error details:', {
          message: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code
        });
        
        if (error.code === '42P01') {
          showNotification('error', 'La tabla "books" no existe. Créala en Supabase.');
        } else if (error.code === '42703') {
          showNotification('error', 'Columna no encontrada. Verifica el esquema de la tabla.');
        } else if (error.code === '42501') {
          showNotification('error', 'Sin permisos. Verifica las políticas RLS.');
        } else {
          showNotification('error', 'Error en base de datos: ' + error.message);
        }
        return;
      }
      
      console.log('Book saved successfully:', data);
      console.log('Book ID:', data?.id);
      console.log('Book front_url:', data?.front_url);
      
      showNotification('success', '¡Libro guardado correctamente!'); 
      Modals.close('addBookModal'); 
      await Books.loadMine(); 
      UI.showTab('library');
      
      try {
        await PointsSystem.award(currentUser.id, 'book_added', 20);
        showNotification('success', '¡Has ganado 20 puntos por añadir un libro!');
      } catch (e) {
        console.warn('Points award error:', e);
      }
      
    } catch(e) { 
      console.error('Save book error:', e);
      showNotification('error', e.message || 'No se pudo guardar el libro'); 
    } finally { 
      btn.disabled = false; 
      btn.innerHTML = '<i class="fas fa-save"></i> Guardar libro'; 
    }
  },

  async uploadImage(type, file, userId) {
    if (!file || !supabaseClient) {
      throw new Error('Archivo o cliente de Supabase no disponible');
    }

    console.log(`🚀 Starting upload for ${type}:`, {
      name: file.name,
      size: file.size,
      type: file.type
    });

    try {
      const ext = (file.name?.split('.').pop() || 'jpg').toLowerCase();
      const timestamp = Date.now();
      const path = `${userId}/${timestamp}-${type}.${ext}`;

      console.log(`📥 Upload path: ${path}`);

      const { data: uploadData, error: uploadError } = await supabaseClient.storage
        .from(BUCKET)
        .upload(path, file, {
          contentType: file.type || 'image/jpeg',
          cacheControl: '3600',
          upsert: false
        });
        
      if (uploadError) {
        console.error(`⚠️ Upload error for ${type}:`, uploadError);
        throw new Error(`Error al subir ${type}: ${uploadError.message}`);
      }

      const { data: urlData } = supabaseClient.storage.from(BUCKET).getPublicUrl(path);
      const publicUrl = urlData?.publicUrl;
      
      if (!publicUrl) {
        throw new Error(`No se pudo obtener URL pública para ${type}`);
      }
      
      console.log(`✅ Upload successful for ${type}:`, publicUrl);
      return publicUrl;
      
    } catch (error) {
      console.error(`⚠️ Upload failed for ${type}:`, error);
      throw error;
    }
  },

  card(b) {
    console.log('Rendering book card:', b);
    const imageUrl = b.front_url;
    console.log(`Image URL for ${b.title}: ${imageUrl}`);
    
    return `<div class="book-card" onclick="Books.open('${b.id}')">
      <div class="book-cover">
        ${imageUrl ? `<img src="${imageUrl}" alt="${b.title}" onerror="console.error('Image failed to load:', this.src)">` : '<i class="fas fa-book"></i>'}
      </div>
      <div class="book-info">
        <div class="book-title" title="${b.title}">${b.title}</div>
        <div class="book-author">${b.author}</div>
        <div class="badge">${(b.condition || '').toUpperCase()}</div>
      </div>
    </div>`;
  },

  async loadMine() {
    if (!currentUser || !supabaseClient) return;
    const grid = document.getElementById('libraryGrid');
    console.log('Loading user books...');
    console.log(`Current user ID: ${currentUser.id}`);
    
    try {
      const { data, error } = await supabaseClient
        .from('books')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('is_available', true)
        .is('exchanged_at', null)  // ← AÑADE ESTA LÍNEA
        .order('created_at', { ascending: false });
        
      if (error) {
        console.error('Database query error:', error);
        console.error('Error details:', {
          message: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code
        });
        
        if (error.code === '42P01') {
          grid.innerHTML = '<div class="empty"><i class="fas fa-exclamation-triangle"></i><div>La tabla "books" no existe</div><div class="hint">Créala en Supabase Database</div></div>';
        } else if (error.code === '42501') {
          grid.innerHTML = '<div class="empty"><i class="fas fa-lock"></i><div>Sin permisos de lectura</div><div class="hint">Verifica las políticas RLS</div></div>';
        } else {
          grid.innerHTML = `<div class="empty">Error: ${error.message}</div>`;
        }
        throw error;
      }
      
      console.log('Loaded books:', data);
      console.log(`Number of books: ${data?.length || 0}`);
      
      userBooks = data || [];
      
      grid.innerHTML = userBooks.length 
        ? userBooks.map(Books.card).join('') 
        : '<div class="empty"><i class="fas fa-book"></i><div>Sin libros aún</div><div class="hint">Pulsa "Añadir libro" para empezar</div></div>';
        
    } catch(err) { 
      console.error('loadMine error:', err);
    }
  },

  async open(id) {
    let book = (userBooks || []).find(x => x.id === id) || (matches || []).find(x => x.id === id);
    if (!book) {
      try { 
        const { data } = await supabaseClient.from('books').select('*').eq('id', id).maybeSingle(); 
        book = data || null; 
      } catch(_) { 
        book = null; 
      }
    }
    if (!book) { 
      showNotification('error', 'No se pudo cargar el libro'); 
      return; 
    }

    console.log('Book details:', {
      id: book.id,
      title: book.title,
      is_available: book.is_available,
      user_id: book.user_id,
      current_user_id: currentUser?.id,
      is_own_book: book.user_id === currentUser?.id
    });

    document.getElementById('bookDetailsTitle').textContent = book.title;
    
    const isOwnBook = book.user_id === currentUser?.id;
    const isAvailable = book.is_available !== false;
    const hasActiveUser = !!currentUser;
    
    console.log('Exchange logic:', {
      isOwnBook,
      isAvailable, 
      hasActiveUser,
      canExchange: hasActiveUser && !isOwnBook && isAvailable
    });
    
    let exchangeBtn;
    if (!hasActiveUser) {
      exchangeBtn = `<button class="btn btn-primary" onclick="showNotification('info', 'Inicia sesión para proponer intercambios')"><i class="fas fa-handshake"></i> Iniciar sesión para intercambiar</button>`;
    } else if (isOwnBook) {
      exchangeBtn = `<button class="btn btn-secondary" disabled><i class="fas fa-user"></i> Tu propio libro</button>`;
    } else if (!isAvailable) {
      exchangeBtn = `<button class="btn btn-warning" onclick="Books.checkAvailability('${book.id}')"><i class="fas fa-clock"></i> Verificar disponibilidad</button>`;
    } else {
      exchangeBtn = `<button class="btn btn-primary" onclick="Matches.startExchange('${book.id}')"><i class="fas fa-handshake"></i> Proponer intercambio</button>`;
    }
    
    const contactBtn = hasActiveUser 
      ? `<button class="btn btn-secondary" onclick="Matches.contactOwner('${book.user_id}','${(book.title || '').replace(/'/g,'&#39;')}')"><i class="fas fa-message"></i> Contactar</button>`
      : '';

    document.getElementById('bookDetailsBody').innerHTML = `
      ${book.front_url ? `<img src="${book.front_url}" style="width:100%;border-radius:10px;margin-bottom:1rem">` : ''}
      <div style="margin-bottom:.5rem"><strong>Autor:</strong> ${book.author || '—'}</div>
      ${book.isbn ? `<div style="margin-bottom:.5rem"><strong>ISBN:</strong> ${book.isbn}</div>` : ''}
      <div style="margin-bottom:.5rem"><strong>Género:</strong> ${book.genre || '—'}</div>
      <div style="margin-bottom:.5rem"><strong>Estado:</strong> ${book.condition || '—'}</div>
      ${book.internal_condition ? `<div style="margin-bottom:.5rem"><strong>Páginas:</strong> ${book.internal_condition}</div>` : ''}
      ${book.description ? `<div style="margin-bottom:.5rem"><strong>Descripción:</strong> ${book.description}</div>` : ''}
      <div style="margin-bottom:1rem"><span class="zone-badge">${(book.zone || '').toUpperCase()}</span></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        ${contactBtn}
        ${exchangeBtn}
      </div>`;
    document.getElementById('bookDetailsModal').classList.add('active'); 
    document.body.classList.add('modal-open');
  },

  async checkAvailability(bookId) {
    try {
      const { data: activeExchanges } = await supabaseClient
        .from('exchanges')
        .select('id, status, created_at, requester_id')
        .eq('requested_book_id', bookId)
        .in('status', ['proposed', 'accepted']);
      
      if (!activeExchanges || activeExchanges.length === 0) {
        await supabaseClient
          .from('books')
          .update({ is_available: true })
          .eq('id', bookId);
        
        showNotification('success', 'Libro desbloqueado. Ya puedes proponer intercambio.');
        
        this.open(bookId);
      } else {
        const exchange = activeExchanges[0];
        const timeAgo = Math.floor((Date.now() - new Date(exchange.created_at)) / (1000 * 60 * 60));
        showNotification('info', `El libro tiene una propuesta ${exchange.status} desde hace ${timeAgo}h. Contacta al propietario.`);
      }
    } catch (e) {
      console.error('Check availability error:', e);
      showNotification('error', 'No se pudo verificar la disponibilidad');
    }
  }
};

/* ===== Matches ===== */
const Matches = {
  async load() {
    if (!currentUser || !supabaseClient) return;
    const container = document.getElementById('matchContainer');
    try {
      const { data: profile } = await supabaseClient.from('profiles').select('zone').eq('id', currentUser.id).single();
      const { data: myBooks } = await supabaseClient.from('books').select('genre,title,author').eq('user_id', currentUser.id);

      let all = [];
      try {
        const res = await supabaseClient.from('books').select('*').eq('is_available', true).neq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(50);
        if (res.error) throw res.error; 
        all = res.data || [];
      } catch(_) {
        const res = await supabaseClient.from('books').select('*').neq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(50);
        all = res.data || [];
      }

      const zone = profile?.zone || 'centro';
      const keywords = new Set();
      (myBooks || []).forEach(b => {
        (`${b.title} ${b.author}`).toLowerCase().split(/\s+/).filter(w => w.length > 3).forEach(w => keywords.add(w));
        if (b.genre) keywords.add(b.genre);
      });

      const scored = (all || []).map(b => {
        let score = 0;
        score += (b.zone === zone ? 100 : (!b.zone || b.zone === 'centro' ? 50 : 20));
        if ((myBooks || []).map(x => x.genre).filter(Boolean).includes(b.genre)) score += 80;
        const text = `${b.title} ${b.author} ${b.description || ''}`.toLowerCase();
        keywords.forEach(k => { 
          if (text.includes(String(k).toLowerCase())) score += 60; 
        });
        const days = (Date.now() - new Date(b.created_at)) / 86400000; 
        if (days < 7) score += 30; 
        else if (days < 30) score += 15;
        if (['nuevo', 'excelente'].includes(b.condition)) score += 40;
        return { ...b, compatibility_score: score };
      }).sort((a, b) => b.compatibility_score - a.compatibility_score).slice(0, 20);

      matches = scored;
      container.innerHTML = matches.length ? matches.map(Books.card).join('')
        : '<div class="empty"><i class="fas fa-book-reader"></i><div>No hay matches disponibles</div><div class="hint">Añade más libros para encontrar coincidencias</div></div>';
    } catch(_) { 
      container.innerHTML = '<div class="empty">Error al cargar matches</div>'; 
    }
  },

  startExchange(bookId) {
    const book = matches.find(b => b.id === bookId) || userBooks.find(b => b.id === bookId);
    if (!currentUser) {
      showNotification('info', 'Inicia sesión para proponer intercambios');
      return;
    }
    Exchange.open(bookId, book?.user_id);
  },

  async contactOwner(ownerUserId, bookTitle) {
    if (!currentUser) {
      showNotification('info', 'Inicia sesión para contactar a otros usuarios');
      return;
    }
    
    try {
      const { data: prof } = await supabaseClient.from('profiles').select('threema_id, full_name').eq('id', ownerUserId).single();
      const targetId = (prof?.threema_id || '').trim().toUpperCase();
      if (!targetId) { 
        showNotification('warning', 'La otra persona aún no ha configurado su Threema'); 
        return; 
      }
      const myName = (currentUser?.user_metadata?.full_name || currentUser?.user_metadata?.name || 'un lector');
      const msg = `Hola, soy ${myName}. Me interesa tu libro "${bookTitle}". ¿Intercambiamos?`;
      Threema.message(targetId, msg);
    } catch(_) { 
      showNotification('error', 'No se pudo abrir Threema'); 
    }
  }
};

/* ===== Exchange System - Actualizado ===== */
const Exchange = {
  targetBook: null,
  statusLabel(s) { 
    const m = {
      proposed: 'Propuesto',
      accepted: 'Aceptado',
      declined: 'Rechazado',
      cancelled: 'Cancelado',
      completed: 'Completado'
    }; 
    return (m[s] || s || '').toUpperCase(); 
  },

  open(requestedBookId, ownerId) {
    if (!currentUser) return;
    this.targetBook = { id: requestedBookId, owner_id: ownerId };
    const select = document.getElementById('offerBookSelect');
    const mine = (userBooks || []).filter(b => b.is_available !== false);
    select.innerHTML = mine.length ? mine.map(b => `<option value="${b.id}">${b.title} – ${b.author}</option>`).join('') : '<option value="">No tienes libros disponibles aún</option>';
    
    ['exchangeNote', 'exchangePlace', 'exchangeTime'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    
    document.getElementById('exchangeModal').classList.add('active'); 
    document.body.classList.add('modal-open');
  },

  create: async function() {
  var btn = document.getElementById('createExchangeBtn'); 
  if (!this.targetBook) return;
  var offeredSelect = document.getElementById('offerBookSelect');
  var offeredId = offeredSelect ? offeredSelect.value : null;
  if (!offeredId) {
    if (typeof showNotification === 'function') showNotification('warning', 'Selecciona el libro que ofreces');
    return;
  }
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando…'; }
  try {
    var ownerId = this.targetBook.owner_id;
    if (!ownerId && window.supabaseClient) { 
      var __resp = await supabaseClient.from('books').select('user_id').eq('id', this.targetBook.id).single(); 
      var b = __resp && __resp.data; 
      ownerId = b && b.user_id; 
    }
    var expiresAt = new Date(Date.now() + ((window.TRADE_EXPIRY_DAYS || 7) * 86400000)).toISOString();
    var noteEl = document.getElementById('exchangeNote');
    var placeEl = document.getElementById('exchangePlace');
    var timeEl  = document.getElementById('exchangeTime');
    var sanitize = window.InputSanitizer && typeof InputSanitizer.sanitizeText === 'function' ? InputSanitizer.sanitizeText : function(x){return x;};
    var basePayload = {
      requested_book_id: this.targetBook.id,
      offered_book_id: offeredId,
      owner_id: ownerId,
      requester_id: currentUser.id,
      note: noteEl ? sanitize(noteEl.value) : null,
      meeting_place: placeEl ? sanitize(placeEl.value) : null,
      meeting_time: (timeEl && timeEl.value) ? new Date(timeEl.value).toISOString() : null,
      expires_at: expiresAt,
      status: 'proposed'
    };
    var isLoan = (window.currentTransactionType === 'loan');
    var payload = basePayload;
    payload.transaction_type = isLoan ? 'loan' : 'exchange';
    if (isLoan) {
      var days = Number(window.selectedDurationDays || 15);
      var due = new Date(Date.now() + days * 86400000).toISOString();
      payload.loan_duration_days = days;
      payload.due_date = due;
    }
    if (window.supabaseClient) {
      var ins = await supabaseClient.from('exchanges').insert([payload]); 
      if (ins && ins.error) throw ins.error;
    }
    try {
      var reqId = this.targetBook.id;
      if (reqId && window.supabaseClient) {
        await supabaseClient.from('books').update({ is_available: false }).eq('id', reqId);
      }
    } catch(__) {}
    if (typeof showNotification === 'function') showNotification('success', isLoan ? 'Solicitud de préstamo enviada' : 'Propuesta de intercambio enviada'); 
    if (window.Modals && Modals.close) Modals.close('exchangeModal'); 
    if (this.list) this.list();
  } catch(e) { 
    if (typeof showNotification === 'function') showNotification('error', e.message || 'No se pudo crear la propuesta'); 
  } finally { 
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar propuesta'; }
  }
},

  async list() {
    if (!currentUser || !supabaseClient) return;
    const el = document.getElementById('exchangeList'); 
    el.innerHTML = '<div class="hint">Cargando…</div>';
    
    try {
      const { data, error } = await supabaseClient
        .from('exchanges')
        .select('id,status,note,meeting_place,meeting_time,created_at,owner_id,requester_id,owner_confirmed,requester_confirmed,completed_at,requested_book_id,offered_book_id,transaction_type')
        .or(`owner_id.eq.${currentUser.id},requester_id.eq.${currentUser.id}`)
        .neq('status', 'completed')
        .order('created_at', { ascending: false });
        
      if (error) throw error;
      
      // Obtener los IDs de todos los libros involucrados
      const bookIds = Array.from(new Set([
        ...(data || []).map(ex => ex.requested_book_id),
        ...(data || []).map(ex => ex.offered_book_id)
      ].filter(Boolean)))
      
      // Cargar la información de los libros
      let booksInfo = {};
      if (bookIds.length > 0) {
        const { data: books } = await supabaseClient
          .from('books')
          .select('id, title, author, front_url')
          .in('id', bookIds);
        
        if (books) {
          books.forEach(book => {
            booksInfo[book.id] = book;
          });
        }
      }
      
      el.innerHTML = (data || []).length 
        ? data.map(ex => this.card(ex, booksInfo)).join('') 
        : '<div class="empty"><i class="fas fa-handshake"></i><div>No tienes intercambios activos</div></div>';
    } catch(_) { 
      el.innerHTML = '<div class="empty">No se pudieron cargar los intercambios</div>'; 
    }
  },

  card(ex, booksInfo) {
    const isRequester = ex.requester_id === currentUser.id;

    var isLoan = ex.transaction_type === 'loan';
    var loanInfo = '';
    if (isLoan && ex.due_date) {
      var ms = new Date(ex.due_date).getTime() - Date.now();
      var daysLeft = Math.max(0, Math.ceil(ms / 86400000));
      loanInfo = '<div style="display:flex;justify-content:space-between;align-items:center;margin:.5rem 0">'+
        '<span class="hint">Devolver antes del: <strong>'+ new Date(ex.due_date).toLocaleDateString('es-ES') +'</strong></span>'+
        '<span class="loan-countdown">'+ daysLeft + ' día' + (daysLeft===1?'':'s') + ' restantes</span>'+
      '</div>';
    }

    const when = ex.meeting_time ? new Date(ex.meeting_time).toLocaleString() : 'Sin fecha';
    const youConf = isRequester ? ex.requester_confirmed : ex.owner_confirmed;
    const otherConf = isRequester ? ex.owner_confirmed : ex.requester_confirmed;
    
    // Obtener información de los libros
    const requestedBook = booksInfo[ex.requested_book_id] || {};
    const offeredBook = booksInfo[ex.offered_book_id] || {};

    let actions = '';
    if (ex.status === 'proposed') {
      actions = isRequester
        ? `<button class="btn btn-secondary" onclick="Exchange.updateStatus('${ex.id}','cancelled')">Cancelar</button>`
        : `<button class="btn btn-primary" onclick="Exchange.updateStatus('${ex.id}','accepted')">Aceptar</button>
           <button class="btn btn-secondary" onclick="Exchange.updateStatus('${ex.id}','declined')">Rechazar</button>`;
    } else if (ex.status === 'accepted') {
      if (youConf && otherConf) actions = '<span class="hint">Ambos confirmaron</span>';
      else if (youConf && !otherConf) actions = '<span class="hint">Ya confirmaste. Esperando a la otra persona…</span>';
      else actions = `<button class="btn btn-primary" onclick="Exchange.confirm('${ex.id}')"><i class="fas fa-check"></i> Confirmar intercambio</button>`;
    }

    // Sección de información de libros con estilo mejorado
    const booksSection = `
      <div style="background: var(--primary-pale); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
        <div style="display: flex; gap: 1rem; align-items: start;">
          ${requestedBook.front_url ? 
            `<img src="${requestedBook.front_url}" style="width: 50px; height: 70px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" alt="Portada">` : 
            '<div style="width: 50px; height: 70px; background: #e0e0e0; border-radius: 4px; display: grid; place-items: center;"><i class="fas fa-book" style="color: #999;"></i></div>'}
          <div style="flex: 1;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
              <strong>${isRequester ? 'Libro que solicitas:' : 'Tu libro solicitado:'}</strong>
            </div>
            <div style="font-weight: 600; color: var(--primary-wood);">
              ${requestedBook.title || 'Título no disponible'}
            </div>
            <div style="font-size: 0.9rem; color: #555;">
              ${requestedBook.author || 'Autor desconocido'}
            </div>
          </div>
        </div>
        
        <div style="border-top: 1px solid rgba(0,0,0,0.1); margin: 0.75rem 0;"></div>
        
        <div style="display: flex; gap: 1rem; align-items: start;">
          ${offeredBook.front_url ? 
            `<img src="${offeredBook.front_url}" style="width: 50px; height: 70px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" alt="Portada">` : 
            '<div style="width: 50px; height: 70px; background: #e0e0e0; border-radius: 4px; display: grid; place-items: center;"><i class="fas fa-book" style="color: #999;"></i></div>'}
          <div style="flex: 1;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
              <strong>${isRequester ? 'Tu libro ofrecido:' : 'Libro que te ofrecen:'}</strong>
            </div>
            <div style="font-weight: 600; color: var(--primary-wood);">
              ${offeredBook.title || 'Título no disponible'}
            </div>
            <div style="font-size: 0.9rem; color: #555;">
              ${offeredBook.author || 'Autor desconocido'}
            </div>
          </div>
        </div>
      </div>
    `;

    return `
      <div class="exchange-card">
        <div style="margin-bottom:.25rem">
          <span class="badge">${this.statusLabel(ex.status)}</span>
          ${isRequester ? 
            '<span class="hint" style="margin-left: 0.5rem;"><i class="fas fa-arrow-right"></i> Propuesta enviada</span>' : 
            '<span class="hint" style="margin-left: 0.5rem;"><i class="fas fa-arrow-left"></i> Propuesta recibida</span>'}
        </div>
        
        ${booksSection}
        
        <div class="hint">📍 Lugar: ${ex.meeting_place || '—'} · 📅 Fecha: ${when}</div>
        ${ex.note ? `<div style="margin-top:.25rem; padding: 0.5rem; background: #f9f9f9; border-radius: 6px; border-left: 3px solid var(--primary-wood);"><i class="fas fa-comment"></i> ${ex.note}</div>` : ''}
        ${ex.status === 'accepted' ? `<div class="hint" style="margin-top:.25rem">Confirmaciones: tú ${youConf ? '✔' : '—'} · otra persona ${otherConf ? '✔' : '—'}</div>` : ''}
        <div style="display:flex;gap:.5rem;margin-top:.75rem">${actions}</div>
      </div>`;
  },

  async updateStatus(id, status) {
    try {
      if (status === 'completed') return this.confirm(id);
      
      const { error } = await supabaseClient.from('exchanges').update({ status }).eq('id', id);
      if (error) throw error;
      
      if (status === 'accepted') {
        showNotification('success', 'Intercambio aceptado. Confirma cuando lo realicéis.');
      }
      if (status === 'declined') showNotification('info', 'Has rechazado la propuesta.');
      if (status === 'cancelled') showNotification('info', 'Has cancelado la propuesta.');
      
      try { 
        const { data: exRow } = await supabaseClient.from('exchanges').select('requested_book_id').eq('id', id).single(); 
        if (exRow?.requested_book_id) {
          await supabaseClient.from('books').update({ is_available: true }).eq('id', exRow.requested_book_id);
        }
      } catch(_) {}
      
      this.list();
      if (window.Matches) Matches.load();
    } catch(_) { 
      showNotification('error', 'No se pudo actualizar el intercambio'); 
    }
  },
async confirm(id) {
  try {
    console.log(`Usuario ${currentUser.id} confirmando intercambio ${id}`);
    
    // Obtener intercambio
    const { data: exchange } = await supabaseClient
      .from('exchanges')
      .select('*')
      .eq('id', id)
      .single();
    
    if (exchange.status === 'completed') {
      console.log('Ya estaba completado');
      await this.list();
      await Profile.load();
      await Profile.loadHistory();
      return;
    }
    
    // Actualizar mi confirmación
    const isOwner = exchange.owner_id === currentUser.id;
    const updateField = isOwner ? 'owner_confirmed' : 'requester_confirmed';
    
    if (exchange[updateField]) {
      console.log('Ya había confirmado');
      return;
    }
    
    await supabaseClient
      .from('exchanges')
      .update({ [updateField]: true })
      .eq('id', id);
    
    // Verificar si ambos confirmaron
    const { data: check } = await supabaseClient
      .from('exchanges')
      .select('*')
      .eq('id', id)
      .single();
    
    if (check.owner_confirmed && check.requester_confirmed && check.status === 'accepted') {
      console.log('Ambos confirmaron, completando...');
      
      const nowIso = new Date().toISOString();
      
      // 1. Completar intercambio
      await supabaseClient
        .from('exchanges')
        .update({ 
          status: 'completed', 
          completed_at: nowIso 
        })
        .eq('id', id);
      
      // 2. IMPORTANTE: Actualizar AMBOS libros
      console.log('Actualizando libros:', check.requested_book_id, check.offered_book_id);
      
      const { data: updatedBooks, error: booksError } = await supabaseClient
        .from('books')
        .update({ 
          is_available: false,
          exchanged_at: nowIso 
        })
        .in('id', [check.requested_book_id, check.offered_book_id])
        .select();
      
      if (booksError) {
        console.error('ERROR actualizando libros:', booksError);
      } else {
        console.log('Libros actualizados:', updatedBooks);
      }
      
     // 3. Los puntos se otorgan automáticamente por el trigger SQL
// await PointsSystem.award(check.owner_id, 'exchange_completed', 50);
// await PointsSystem.award(check.requester_id, 'exchange_completed', 50);
      
showNotification('success', '¡Intercambio completado! Ambos ganan 50 puntos');
} else {
showNotification('info', 'Tu confirmación ha sido registrada');
}
    
    // Recargar todo
    await Books.loadMine();
    await Matches.load();
    await this.list();
    await Profile.load();
    await Profile.loadHistory();
    
  } catch(error) {
    console.error('Error completo:', error);
    showNotification('error', 'Error al confirmar');
  }
},
cleanup() {
  this.targetBook = null;
}
};  // Punto y coma para cerrar el objeto Exchange


/* ===== Points System - VERSIÓN MEJORADA ===== */
const PointsSystem = {
  async award(userId, action, pts = 20) {
    try {
      if (!supabaseClient || !userId) {
        console.error('Falta supabaseClient o userId');
        return false;
      }
      
      console.log(`Otorgando ${pts} puntos a usuario ${userId} por ${action}`);
      
      // Insertar transacción
      await supabaseClient.from('points_transactions').insert([{
        user_id: userId,
        action_type: action,
        points: pts
      }]);
      
      // Obtener puntos actuales
      const { data: prof } = await supabaseClient
        .from('profiles')
        .select('total_points')
        .eq('id', userId)
        .single();
      
      const currentPoints = prof?.total_points || 0;
      const newTotal = currentPoints + pts;
      
      console.log(`Actualizando: ${currentPoints} + ${pts} = ${newTotal}`);
      
      // Actualizar total
      await supabaseClient
        .from('profiles')
        .update({ total_points: newTotal })
        .eq('id', userId);
      
      // Actualizar UI si es el usuario actual
      if (userId === currentUser?.id) {
        const pointsEl = document.getElementById('userPoints');
        if (pointsEl) pointsEl.textContent = newTotal;
      }
      
      console.log(`✅ Puntos actualizados para ${userId}: ${newTotal}`);
      return true;
      
    } catch(e) {
      console.error('Points award error:', e);
      return false;
    }
  }
};

  /* ===== Profile Management - VERSIÓN COMPLETA ===== */
const Profile = {
  async load() {
    const el = document.getElementById('profileContent');
    
    if (!currentUser || !supabaseClient) { 
      el.innerHTML = '<div class="empty">Inicia sesión</div>'; 
      return; 
    }
    
    try {
      let { data } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
      if (!data) {
        const defaults = {
          id: currentUser.id,
          email: currentUser.email,
          full_name: currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || 'Usuario',
          zone: 'centro', 
          total_points: 0, 
          membership: 'Básica'
        };
        const { error: insertError } = await supabaseClient.from('profiles').insert([defaults]);
        if (!insertError) data = defaults;
      }
      
      if (data) {
        const pointsEl = document.getElementById('userPoints');
        if (pointsEl) pointsEl.textContent = data.total_points ?? 0;
        
        el.innerHTML = `
          <div style="background:#fff;border:1px solid var(--primary-soft);border-radius:12px;padding:1rem;box-shadow:var(--shadow)">
            <div style="display:flex;align-items:center;gap:.8rem;margin-bottom:.75rem">
              <div style="width:64px;height:64px;border-radius:50%;background:var(--primary-soft);display:grid;place-items:center;font-weight:800">
                ${(data.full_name || 'U').charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight:700">${data.full_name || 'Usuario'}</div>
                <div class="hint">${data.email || ''}</div>
              </div>
            </div>
            <div style="display:grid;gap:.5rem">
              <div style="display:flex;justify-content:space-between;background:var(--primary-pale);padding:.6rem;border-radius:10px"><span><i class="fas fa-map-marker-alt"></i> Zona</span><strong>${data.zone || '—'}</strong></div>
              <div style="display:flex;justify-content:space-between;background:var(--primary-pale);padding:.6rem;border-radius:10px"><span><i class="fas fa-coins"></i> Puntos</span><strong>${data.total_points ?? 0}</strong></div>
              <div style="display:flex;justify-content:space-between;background:var(--primary-pale);padding:.6rem;border-radius:10px"><span><i class="fas fa-crown"></i> Membresía</span><strong>${data.membership || 'Básica'}</strong></div>
              <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
                <button class="btn btn-primary" onclick="Profile.openEdit('${encodeURIComponent(data.full_name || '')}','${data.zone || 'centro'}')"><i class="fas fa-user-pen"></i> Editar perfil</button>
              </div>
            </div>
          </div>`;
          
        // Cargar el historial después
        await this.loadHistory();
      }
    } catch(e) { 
      console.error('Profile load error:', e);
      el.innerHTML = '<div class="empty">No se pudo cargar tu perfil</div>'; 
    }
  },

  async loadHistory() {
    // Tu código de loadHistory está bien, déjalo como está
    const el = document.getElementById('profileHistory');
    if (!el) {
      console.error('No se encontró el contenedor profileHistory');
      return;
    }
    
    if (!currentUser || !supabaseClient) {
      console.error('No hay usuario o supabaseClient');
      return;
    }
    
    console.log('Cargando historial para usuario:', currentUser.id);
    
    try {
      const { data: exchanges, error } = await supabaseClient
        .from('exchanges')
        .select('*')
        .or(`owner_id.eq.${currentUser.id},requester_id.eq.${currentUser.id}`)
        .eq('status', 'completed')
        .order('completed_at', { ascending: false })
        .limit(10);
        
      if (error) {
        console.error('Error cargando intercambios:', error);
        throw error;
      }
      
      console.log('Intercambios completados encontrados:', exchanges?.length || 0);
      
      if (!exchanges || exchanges.length === 0) {
        el.innerHTML = `
          <div class="empty">
            <i class="fas fa-handshake"></i>
            <div>Aún no tienes intercambios completados</div>
          </div>`;
        return;
      }
      
      const bookIds = Array.from(new Set([
        ...exchanges.map(e => e.requested_book_id),
        ...exchanges.map(e => e.offered_book_id)
      ].filter(Boolean)))
      
      console.log('IDs de libros a buscar:', bookIds);
      
      let books = {};
      if (bookIds.length > 0) {
        const { data: bookData } = await supabaseClient
          .from('books')
          .select('id, title, author, front_url')
          .in('id', bookIds);
        
        if (bookData) {
          bookData.forEach(book => {
            books[book.id] = book;
          });
        }
      }
      
      const historyHtml = exchanges.map(ex => {
        const date = new Date(ex.completed_at).toLocaleDateString();
        const isRequester = ex.requester_id === currentUser.id;
        
        const receivedBookId = isRequester ? ex.requested_book_id : ex.offered_book_id;
        const givenBookId = isRequester ? ex.offered_book_id : ex.requested_book_id;
        
        const receivedBook = books[receivedBookId];
        const givenBook = books[givenBookId];
        
        return `
          <div class="hist-row" style="margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--primary-soft)">
            <div style="display:flex;gap:.75rem;align-items:center;margin-bottom:0.5rem">
              ${receivedBook?.front_url ? 
                `<img src="${receivedBook.front_url}" class="hist-thumb" style="width:50px;height:70px;object-fit:cover;border-radius:4px" alt="${receivedBook.title}">` : 
                '<div class="hist-thumb" style="width:50px;height:70px;background:#f0f0f0;border-radius:4px;display:grid;place-items:center"><i class="fas fa-book"></i></div>'}
              <i class="fas fa-exchange-alt" style="color:#999"></i>
              ${givenBook?.front_url ? 
                `<img src="${givenBook.front_url}" class="hist-thumb" style="width:50px;height:70px;object-fit:cover;border-radius:4px" alt="${givenBook.title}">` : 
                '<div class="hist-thumb" style="width:50px;height:70px;background:#f0f0f0;border-radius:4px;display:grid;place-items:center"><i class="fas fa-book"></i></div>'}
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;margin-bottom:.25rem">Intercambio completado</div>
              <div style="margin-bottom:.25rem">
                <strong>Libro recibido:</strong> ${receivedBook ? `${receivedBook.title} - ${receivedBook.author}` : '<em>Información no disponible</em>'}
              </div>
              <div style="margin-bottom:.25rem">
                <strong>Libro entregado:</strong> ${givenBook ? `${givenBook.title} - ${givenBook.author}` : '<em>Información no disponible</em>'}
              </div>
              <div class="hint">${date}</div>
            </div>
          </div>`;
      }).join('');
      
      el.innerHTML = historyHtml;
      console.log('Historial renderizado correctamente');
      
    } catch (e) {
      console.error('Error completo al cargar historial:', e);
      el.innerHTML = '<div class="empty">Error al cargar el historial</div>';
    }
  },

  openEdit(name, zone) {
    const nameEl = document.getElementById('editFullName');
    const zoneEl = document.getElementById('editZone');
    
    if (nameEl) nameEl.value = decodeURIComponent(name);
    if (zoneEl) zoneEl.value = zone;
    
    const modal = document.getElementById('editProfileModal');
    if (modal) {
      modal.classList.add('active');
      document.body.classList.add('modal-open');
    }
  },

  async saveEdit() {
    if (!currentUser || !supabaseClient) return;
    
    const name = InputSanitizer.sanitizeText(document.getElementById('editFullName').value);
    const zone = document.getElementById('editZone').value;
    
    if (!name || !zone) {
      showNotification('warning', 'Completa todos los campos');
      return;
    }
    
    const btn = document.getElementById('saveProfileBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    
    try {
      const { error } = await supabaseClient
        .from('profiles')
        .update({
          full_name: name,
          zone: zone
        })
        .eq('id', currentUser.id);
        
      if (error) throw error;
      
      showNotification('success', 'Perfil actualizado correctamente');
      Modals.close('editProfileModal');
      this.load();
    } catch (e) {
      console.error('Profile save error:', e);
      showNotification('error', 'No se pudo guardar el perfil');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Guardar cambios';
    }
  }
};

/* ===== Weekly Club ===== */
async function loadWeeklyClub() {
  try {
    const weeklyClubs = [
      { title: 'Clásicos Modernos', book: 'Klara y el sol', dates: 'Lun-Vier 19:00', groupId: 'WEEKLYBOOKS' },
      { title: 'Ficción Contemporánea', book: 'Proyecto Hail Mary', dates: 'Mar-Jue 20:30', groupId: 'SCIFICLUB' },
      { title: 'No Ficción', book: 'Sapiens', dates: 'Mié-Sáb 18:00', groupId: 'NONFICTION' }
    ];
    
    const weekNumber = Math.floor(Date.now() / (1000 * 60 * 60 * 24 * 7)) % weeklyClubs.length;
    const club = weeklyClubs[weekNumber];
    
    const titleEl = document.getElementById('weeklyClubTitle');
    const bookEl = document.getElementById('weeklyClubBook');
    const datesEl = document.getElementById('weeklyClubDates');
    const btnEl = document.getElementById('weeklyJoinBtn');
    const btnContainer = document.getElementById('weeklyClubBtnContainer');
    
    if (titleEl) titleEl.textContent = club.title;
    if (bookEl) bookEl.textContent = `Libro actual: ${club.book}`;
    if (datesEl) datesEl.textContent = `Reuniones: ${club.dates}`;
    
    if (window.Guest && Guest.isGuest) {
      if (btnContainer) btnContainer.style.display = 'none';
    } else {
      if (btnContainer) btnContainer.style.display = 'flex';
      
      if (btnEl) {
        btnEl.disabled = false;
        btnEl.onclick = () => {
          if (Threema.config.connected) {
            Threema.message(club.groupId, `Hola, me gustaría unirme al club "${club.title}". Estoy leyendo "${club.book}".`);
          } else {
            showNotification('info', 'Configura Threema primero para unirte a grupos');
            Threema.openConfig();
          }
        };
      }
    }
  } catch (e) {
    console.error('Weekly club load error:', e);
  }
}

async function loadWeeklyClubLibrary() {
  try {
    const weeklyClubs = [
      { title: 'Clásicos Modernos', book: 'Klara y el sol', dates: 'Lun-Vier 19:00', groupId: 'WEEKLYBOOKS' },
      { title: 'Ficción Contemporánea', book: 'Proyecto Hail Mary', dates: 'Mar-Jue 20:30', groupId: 'SCIFICLUB' },
      { title: 'No Ficción', book: 'Sapiens', dates: 'Mié-Sáb 18:00', groupId: 'NONFICTION' }
    ];
    
    const weekNumber = Math.floor(Date.now() / (1000 * 60 * 60 * 24 * 7)) % weeklyClubs.length;
    const club = weeklyClubs[weekNumber];
    
    const titleEl = document.getElementById('weeklyClubTitleLib');
    const bookEl = document.getElementById('weeklyClubBookLib');
    const datesEl = document.getElementById('weeklyClubDatesLib');
    const btnEl = document.getElementById('weeklyJoinBtnLib');
    const btnContainer = document.getElementById('weeklyClubBtnContainerLib');
    
    if (titleEl) titleEl.textContent = club.title;
    if (bookEl) bookEl.textContent = `Libro actual: ${club.book}`;
    if (datesEl) datesEl.textContent = `Reuniones: ${club.dates}`;
    
    if (window.Guest && Guest.isGuest) {
      if (btnContainer) btnContainer.style.display = 'none';
    } else {
      if (btnContainer) btnContainer.style.display = 'flex';
      
      if (btnEl) {
        btnEl.disabled = false;
        btnEl.onclick = () => {
          if (Threema.config.connected) {
            Threema.message(club.groupId, `Hola, me gustaría unirme al club "${club.title}". Estoy leyendo "${club.book}".`);
          } else {
            showNotification('info', 'Configura Threema primero para unirte a grupos');
            Threema.openConfig();
          }
        };
      }
    }
  } catch (e) {
    console.error('Weekly club library load error:', e);
  }
}

/* ===== SISTEMA DE DESCUBRIMIENTO DE INTERESES ===== */

// Sistema de clasificación de usuarios
const UserState = {
  async classify(userId) {
    try {
      const { data: profile } = await supabaseClient
        .from('profiles')
        .select(`
          interests_discovery_completed,
          onboarding_step,
          first_group_joined_at,
          total_points,
          created_at
        `)
        .eq('id', userId)
        .single();
      
      if (!profile) return 'nuevo';
      
      if (!profile.interests_discovery_completed) {
        return 'nuevo';
      }
      
      if (profile.interests_discovery_completed && !profile.first_group_joined_at) {
        return 'discovery_completo';
      }
      
      if (profile.first_group_joined_at) {
        const daysSinceFirstGroup = Math.floor(
          (Date.now() - new Date(profile.first_group_joined_at).getTime()) / (1000 * 60 * 60 * 24)
        );
        
        if (daysSinceFirstGroup < 30) {
          return 'activo_reciente';
        }
      }
      
      return 'experimentado';
      
    } catch (error) {
      console.error('Error classifying user:', error);
      return 'nuevo';
    }
  },

  _cache: new Map(),
  _cacheExpiry: 5 * 60 * 1000,
  
  async classifyWithCache(userId) {
    const cacheKey = `user_state_${userId}`;
    const cached = this._cache.get(cacheKey);
    
    if (cached && (Date.now() - cached.timestamp) < this._cacheExpiry) {
      return cached.state;
    }
    
    const state = await this.classify(userId);
    this._cache.set(cacheKey, { state, timestamp: Date.now() });
    
    return state;
  }
};

// Discovery Cards para diferentes tipos de usuarios
const DiscoveryCards = {
  nuevo: {
    icon: 'fas fa-compass',
    title: 'Encuentra Tu Tribu de Aprendizaje',
    subtitle: '¿Qué te mueve a investigar y aprender?',
    buttonText: 'Empezar',
    buttonIcon: 'fas fa-rocket',
    action: 'InterestDiscovery.showWelcome()',
    style: 'background:linear-gradient(135deg,var(--primary-soft),var(--primary-pale))'
  },
  
  discovery_completo: {
    icon: 'fas fa-users',
    title: 'Únete a Tu Primera Comunidad',
    subtitle: 'Ya conoces tus intereses, encuentra tu grupo',
    buttonText: 'Ver Grupos',
    buttonIcon: 'fas fa-arrow-right',
    action: 'CommunityManager.scrollToGroups()',
    style: 'background:linear-gradient(135deg,var(--success),#4CAF50)'
  },
  
  activo_reciente: {
    icon: 'fas fa-star',
    title: 'Descubre Más Grupos Afines',
    subtitle: 'Amplía tu círculo de intereses',
    buttonText: 'Explorar',
    buttonIcon: 'fas fa-search',
    action: 'InterestDiscovery.showMoreGroups()',
    style: 'background:#fff;border:2px solid var(--primary-wood)'
  },
  
  experimentado: {
    icon: 'fas fa-crown',
    title: 'Lidera Tu Propia Comunidad',
    subtitle: 'Crea un grupo sobre tu pasión',
    buttonText: 'Crear Grupo',
    buttonIcon: 'fas fa-plus-circle',
    action: 'InterestDiscovery.createGroup()',
    style: 'background:linear-gradient(135deg,var(--primary-wood),var(--primary-accent))'
  }
};

// Sistema de Descubrimiento de Intereses
const InterestDiscovery = {
  selectedInterests: new Set(),
  selectedMotivations: new Set(),
  
  showGroupDetails(groupType) {
    if (groupType === 'weekly') {
      showNotification('info', WEEKLY_CLUB_MESSAGE);
    }
  },
  
  showWelcome() {
    const modal = document.getElementById('interestDiscoveryModal');
    if (!modal) {
      console.error('Modal de discovery no encontrado');
      return;
    }
    
    this.selectedInterests.clear();
    this.selectedMotivations.clear();
    
    modal.classList.add('active');
    document.body.classList.add('modal-open');
    
    const customInquiries = document.getElementById('customInquiries');
    const learningBarriers = document.getElementById('learningBarriers');
    if (customInquiries) customInquiries.value = '';
    if (learningBarriers) learningBarriers.value = '';
    
    setTimeout(() => {
      this.bindEvents();
    }, 100);
  },

  bindEvents() {
    console.log('Binding interest discovery events...');
    
    document.querySelectorAll('.interest-tag').forEach(tag => {
      tag.replaceWith(tag.cloneNode(true));
    });
    
    document.querySelectorAll('.interest-tag').forEach(tag => {
      tag.addEventListener('click', (e) => {
        e.preventDefault();
        const interest = tag.dataset.interest;
        if (!interest) return;
        
        if (this.selectedInterests.has(interest)) {
          this.selectedInterests.delete(interest);
          tag.classList.remove('selected');
        } else {
          this.selectedInterests.add(interest);
          tag.classList.add('selected');
        }
        
        console.log('Selected interests:', Array.from(this.selectedInterests));
      });
    });

    document.querySelectorAll('.motivation-card input').forEach(input => {
      input.addEventListener('change', () => {
        if (input.checked) {
          this.selectedMotivations.add(input.value);
        } else {
          this.selectedMotivations.delete(input.value);
        }
        console.log('Selected motivations:', Array.from(this.selectedMotivations));
      });
    });
    
    console.log('Events bound successfully');
  },

  async processInterests() {
    const customInquiries = document.getElementById('customInquiries').value.trim();
    const learningBarriers = document.getElementById('learningBarriers').value.trim();

    if (this.selectedInterests.size === 0 && this.selectedMotivations.size === 0 && !customInquiries && !learningBarriers) {
      showNotification('warning', 'Selecciona al menos un interés o comparte qué te fascina');
      return;
    }

    const userProfile = {
      interests: Array.from(this.selectedInterests),
      motivations: Array.from(this.selectedMotivations),
      customInquiries: customInquiries,
      learningBarriers: learningBarriers,
      timestamp: new Date().toISOString()
    };

    console.log('Processing user profile:', userProfile);

    if (currentUser && supabaseClient) {
      try {
        const { error } = await supabaseClient
          .from('user_interests')
          .upsert({
            user_id: currentUser.id,
            interests: userProfile.interests,
            motivations: userProfile.motivations,
            custom_inquiries: userProfile.customInquiries,
            learning_barriers: userProfile.learningBarriers,
            updated_at: userProfile.timestamp
          });
        
        if (error) {
          console.error('Error saving interests:', error);
        } else {
          await supabaseClient
            .from('profiles')
            .update({ 
              interests_discovery_completed: true,
              onboarding_step: 1
            })
            .eq('id', currentUser.id);
          
          try {
            await PointsSystem.award(currentUser.id, 'profile_completed', 30);
            showNotification('success', '¡Has ganado 30 puntos por completar tu perfil de intereses!');
          } catch (e) {
            console.warn('Points award error:', e);
          }
        }
      } catch (error) {
        console.error('Error saving interests:', error);
        showNotification('error', 'No se pudieron guardar tus intereses');
        return;
      }
    }

    this.showResults(userProfile);
  },

  showResults(profile) {
    Modals.close('interestDiscoveryModal');
    
    const modal = document.getElementById('interestResultsModal');
    const content = document.getElementById('interestResultsContent');
    
    if (!modal || !content) {
      console.error('Modal de resultados no encontrado');
      return;
    }
    
    const suggestedGroups = this.generateSuggestions(profile);
    
    content.innerHTML = `
      <div style="text-align:center;margin-bottom:2rem">
        <div style="font-size:3rem;margin-bottom:1rem">✨</div>
        <p>Basándome en tus intereses, he encontrado estos espacios donde podrías conectar:</p>
      </div>

      ${suggestedGroups.length > 0 ? `
        <div class="suggested-groups">
          <h4>🏠 Grupos Recomendados para Ti:</h4>
          ${suggestedGroups.map(group => `
            <div class="group-card" style="margin-bottom:1rem">
              <div class="group-header">
                <i class="${group.icon}" style="color:var(--primary-wood)"></i>
                <h5>${group.name}</h5>
              </div>
              <p>${group.description}</p>
              <div class="group-stats">
                <span><i class="fas fa-users"></i> ${group.memberCount} miembros</span>
                <span><i class="fas fa-book"></i> ${group.bookCount} libros</span>
              </div>
              <button class="btn btn-primary" onclick="InterestDiscovery.joinGroup('${group.id}')">
                Unirme a Este Grupo
              </button>
            </div>
          `).join('')}
        </div>
      ` : ''}

      ${profile.learningBarriers ? `
        <div class="learning-guidance" style="background:var(--primary-pale);padding:1rem;border-radius:10px;margin:1rem 0">
          <h5><i class="fas fa-lightbulb"></i> Sobre Tu Curiosidad:</h5>
          <p style="font-style:italic">"${profile.learningBarriers}"</p>
          <p>¡Esto suena fascinante! Te sugiero crear un grupo sobre este tema.</p>
          <button class="btn btn-secondary" onclick="InterestDiscovery.createCustomGroup('${encodeURIComponent(profile.learningBarriers)}')">
            <i class="fas fa-plus"></i> Crear Grupo sobre Este Tema
          </button>
        </div>
      ` : ''}

      <div class="next-steps" style="margin-top:2rem">
        <h4>🚀 Próximos Pasos:</h4>
        <div style="display:grid;gap:.5rem">
          <button class="btn btn-secondary" onclick="InterestDiscovery.exploreAllGroups()">
            <i class="fas fa-search"></i> Explorar Todos los Grupos
          </button>
          <button class="btn btn-secondary" onclick="InterestDiscovery.createOwnGroup()">
            <i class="fas fa-users-cog"></i> Crear Mi Propio Grupo
          </button>
          <button class="btn btn-primary" onclick="InterestDiscovery.completeOnboarding()">
            <i class="fas fa-check"></i> ¡Empezar Mi Aventura!
          </button>
        </div>
      </div>
    `;

    modal.classList.add('active');
    document.body.classList.add('modal-open');
  },

  generateSuggestions(profile) {
    const allGroups = [
      {
        id: 'thriller-club',
        name: 'Amantes del Thriller',
        description: 'Para quienes disfrutan de la tensión y el misterio en cada página',
        icon: 'fas fa-search',
        memberCount: 47,
        bookCount: 89,
        tags: ['thriller', 'novela-negra']
      },
      {
        id: 'historia-madrid',
        name: 'Historia Viva de Madrid',
        description: 'Descubrimos los secretos y leyendas de nuestra ciudad',
        icon: 'fas fa-landmark',
        memberCount: 23,
        bookCount: 156,
        tags: ['historia', 'madrid-historia']
      },
      {
        id: 'permacultura-urbana',
        name: 'Permacultura y Vida Sostenible',
        description: 'Aprendemos a vivir en armonía con la naturaleza',
        icon: 'fas fa-seedling',
        memberCount: 31,
        bookCount: 67,
        tags: ['permacultura', 'jardineria']
      },
      {
        id: 'filosofia-practica',
        name: 'Filosofía para la Vida',
        description: 'Reflexiones profundas aplicadas al día a día',
        icon: 'fas fa-brain',
        memberCount: 19,
        bookCount: 203,
        tags: ['filosofia', 'psicologia']
      },
      {
        id: 'cocina-mundial',
        name: 'Cocina del Mundo',
        description: 'Exploramos gastronomías internacionales a través de libros',
        icon: 'fas fa-utensils',
        memberCount: 34,
        bookCount: 78,
        tags: ['cocina', 'gastronomia-local']
      }
    ];

    return allGroups.filter(group => 
      group.tags.some(tag => profile.interests.includes(tag))
    ).slice(0, 3);
  },

  async joinGroup(groupId) {
    if (!currentUser) {
      showNotification('info', 'Inicia sesión para unirte a grupos');
      return;
    }

    try {
      showNotification('success', '¡Te has unido al grupo! Recibirás notificaciones cuando sea el club de la semana.');
      
      try {
        await PointsSystem.award(currentUser.id, 'joined_group', 15);
        showNotification('success', '¡Has ganado 15 puntos por unirte al grupo!');
      } catch (e) {
        console.warn('Points award error:', e);
      }
      
      await supabaseClient
        .from('profiles')
        .update({ 
          first_group_joined_at: new Date().toISOString(),
          onboarding_step: 2
        })
        .eq('id', currentUser.id);
      
      UserState._cache.clear();
      setTimeout(() => {
        if (window.CommunityManager) {
          CommunityManager.loadAdaptive();
        }
      }, 500);
      
    } catch (error) {
      console.error('Error joining group:', error);
      showNotification('error', 'No se pudo unir al grupo');
    }
  },

  completeOnboarding() {
    Modals.close('interestResultsModal');
    showNotification('success', '¡Bienvenido a tu comunidad de aprendizaje!');
    
    UserState._cache.clear();
    setTimeout(() => {
      if (window.CommunityManager) {
        CommunityManager.loadAdaptive();
      }
    }, 500);
  },

  showMoreGroups() {
    showNotification('info', 'Función en desarrollo: Mostrar más grupos');
    Modals.close('interestResultsModal');
  },

  exploreAllGroups() {
    Modals.close('interestResultsModal');
    const groupsList = document.getElementById('availableGroupsList');
    if (groupsList) {
      groupsList.scrollIntoView({ behavior: 'smooth' });
    }
  },

  createOwnGroup() {
    this.openCreateGroupModal();
    Modals.close('interestResultsModal');
  },

  createGroup() {
    this.openCreateGroupModal();
  },

  openCreateGroupModal() {
    if (!currentUser) {
      showNotification('info', 'Inicia sesión para crear grupos');
      return;
    }
    
    const modal = document.getElementById('createGroupModal');
    if (modal) {
      modal.classList.add('active');
      document.body.classList.add('modal-open');
    }
  },

  async submitGroupCreation() {
    const name = InputSanitizer.sanitizeText(document.getElementById('groupName').value);
    const description = InputSanitizer.sanitizeText(document.getElementById('groupDescription').value);
    const category = document.getElementById('groupCategory').value;
    const meetingType = document.getElementById('groupMeetingType').value;
    const frequency = document.getElementById('groupFrequency').value;

    if (!name || !description || !category || !meetingType || !frequency) {
      showNotification('warning', 'Completa todos los campos');
      return;
    }

    const btn = document.getElementById('createGroupBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="loading-spinner"></i> Creando grupo...';

    try {
      // Mock group creation - en producción esto se conectaría a la base de datos
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      showNotification('success', `¡Grupo "${name}" creado exitosamente!`);
      
      try {
        await PointsSystem.award(currentUser.id, 'group_created', 100);
        showNotification('success', '¡Has ganado 100 puntos por crear un grupo!');
      } catch (e) {
        console.warn('Points award error:', e);
      }
      
      Modals.close('createGroupModal');
      
      setTimeout(() => {
        if (window.CommunityManager) {
          CommunityManager.loadAdaptive();
        }
      }, 500);
      
    } catch (error) {
      console.error('Error creating group:', error);
      showNotification('error', 'No se pudo crear el grupo');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-plus-circle"></i> Crear Grupo';
    }
  },

  createCustomGroup(inquiry) {
    const modal = document.getElementById('createGroupModal');
    if (modal) {
      const nameField = document.getElementById('groupName');
      const descField = document.getElementById('groupDescription');
      
      if (nameField && descField) {
        const topic = decodeURIComponent(inquiry);
        nameField.value = `Exploradores de ${topic.split(',')[0]}`;
        descField.value = `Grupo dedicado a explorar y aprender sobre: ${topic}`;
      }
      
      modal.classList.add('active');
      document.body.classList.add('modal-open');
    }
    
    Modals.close('interestResultsModal');
  }
};

// Community Manager - Gestión adaptativa de la interfaz
const CommunityManager = {
  async loadAdaptive() {
    if (!currentUser) {
      this.loadGuestView();
      return;
    }
    
    try {
      const userType = await UserState.classifyWithCache(currentUser.id);
      console.log(`User type detected: ${userType}`);
      
      await this.renderDiscoveryCard(userType);
      await this.loadRelevantContent(userType);
      await this.loadAvailableGroups();
    } catch (error) {
      console.error('Error loading adaptive community:', error);
      this.loadDefaultView();
    }
  },
  
  async renderDiscoveryCard(userType) {
    const card = DiscoveryCards[userType] || DiscoveryCards.nuevo;
    const discoveryCard = document.getElementById('discoveryCard');
    
    if (!discoveryCard) {
      console.error('Discovery card element not found');
      return;
    }
    
    discoveryCard.innerHTML = `
      <div class="row" style="${card.style}">
        <div style="display:flex;align-items:center;gap:12px">
          <i class="${card.icon}" style="font-size:2rem;color:var(--primary-wood)"></i>
          <div>
            <div style="font-weight:700">${card.title}</div>
            <div class="hint">${card.subtitle}</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="${card.action}">
          <i class="${card.buttonIcon}"></i> ${card.buttonText}
        </button>
      </div>`;
  },
  
  async loadRelevantContent(userType) {
    switch(userType) {
      case 'nuevo':
        await this.hideAdvancedFeatures();
        break;
      case 'discovery_completo':
        await this.highlightAvailableGroups();
        break;
      case 'activo_reciente':
        await this.showPersonalizedRecommendations();
        await this.loadMyGroups();
        break;
      case 'experimentado':
        await this.showLeadershipOptions();
        await this.loadMyGroups();
        break;
    }
  },
  
  async loadMyGroups() {
    const section = document.getElementById('myGroupsSection');
    const list = document.getElementById('myGroupsList');
    
    if (!currentUser || !section || !list) return;
    
    try {
      const myGroups = [
        { 
          id: 'thriller-club',
          name: 'Amantes del Thriller', 
          members: 47, 
          isActive: Math.random() > 0.5,
          description: 'Grupo para amantes del suspense'
        },
        { 
          id: 'historia-madrid',
          name: 'Historia Viva de Madrid', 
          members: 23, 
          isActive: Math.random() > 0.5,
          description: 'Exploramos la historia de nuestra ciudad'
        }
      ];

      if (myGroups.length > 0) {
        section.style.display = 'block';
        list.innerHTML = myGroups.map(group => `
          <div class="group-card ${group.isActive ? 'club-indicator' : ''}">
            <div class="group-header">
              <i class="fas fa-users" style="color:var(--primary-wood)"></i>
              <h5>${group.name}</h5>
              ${group.isActive ? '<span class="badge" style="background:var(--success);color:#fff">Activo</span>' : ''}
            </div>
            <p style="font-size:.85rem;margin:.5rem 0">${group.description}</p>
            <div class="group-stats">
              <span><i class="fas fa-users"></i> ${group.members} miembros</span>
            </div>
            <div style="display:flex;gap:.5rem;margin-top:.75rem">
              <button class="btn btn-secondary" onclick="CommunityManager.viewGroupActivity('${group.id}')">
                Ver Actividad
              </button>
              ${group.isActive ? 
                '<button class="btn btn-primary" onclick="joinWeeklyClub()">Participar</button>' :
                '<button class="btn btn-secondary" disabled>En Pausa</button>'
              }
            </div>
          </div>
        `).join('');
      } else {
        section.style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading my groups:', error);
    }
  },

  async loadAvailableGroups() {
    const list = document.getElementById('availableGroupsList');
    if (!list) {
      console.error('availableGroupsList element not found');
      return;
    }
    
    try {
      const groups = [
        { 
          id: 'cocina-mundial',
          name: 'Cocina del Mundo', 
          description: 'Exploramos gastronomías internacionales', 
          members: 34, 
          books: 78,
          icon: 'fas fa-utensils'
        },
        { 
          id: 'ciencia-ficcion',
          name: 'Ciencia Ficción Clásica', 
          description: 'Los grandes maestros del género', 
          members: 28, 
          books: 145,
          icon: 'fas fa-rocket'
        },
        { 
          id: 'arte-creatividad',
          name: 'Arte y Creatividad', 
          description: 'Inspiración a través del arte', 
          members: 19, 
          books: 56,
          icon: 'fas fa-palette'
        },
        { 
          id: 'mindfulness',
          name: 'Mindfulness y Bienestar', 
          description: 'Técnicas para una vida más consciente', 
          members: 42, 
          books: 93,
          icon: 'fas fa-leaf'
        }
      ];

      console.log(`Updating groups list with ${groups.length} groups`);
      
      list.innerHTML = groups.map(group => `
        <div class="group-card">
          <div class="group-header">
            <i class="${group.icon}" style="color:var(--primary-wood)"></i>
            <h5>${group.name}</h5>
          </div>
          <p style="font-size:.85rem;margin:.5rem 0">${group.description}</p>
          <div class="group-stats">
            <span><i class="fas fa-users"></i> ${group.members}</span>
            <span><i class="fas fa-book"></i> ${group.books}</span>
          </div>
          <button class="btn btn-primary" onclick="CommunityManager.joinGroup('${group.id}', '${group.name}')" style="width:100%;margin-top:.75rem">
            <i class="fas fa-plus"></i> Unirme
          </button>
        </div>
      `).join('');
      
      console.log('Groups list updated successfully');
      
    } catch (error) {
      console.error('Error loading available groups:', error);
      list.innerHTML = '<div class="empty">Error al cargar grupos disponibles</div>';
    }
  },
  
  scrollToGroups() {
    const groupsSection = document.getElementById('availableGroupsList');
    if (groupsSection) {
      groupsSection.scrollIntoView({ behavior: 'smooth' });
      groupsSection.style.border = '2px solid var(--primary-wood)';
      setTimeout(() => {
        groupsSection.style.border = 'none';
      }, 2000);
    }
  },

  async joinGroup(groupId, groupName) {
    if (!currentUser) {
      showNotification('info', 'Inicia sesión para unirte a grupos');
      return;
    }

    try {
      showNotification('success', `¡Te has unido al grupo "${groupName}"!`);
      
      await PointsSystem.award(currentUser.id, 'joined_group', 15);
      
      const { data: profile } = await supabaseClient
        .from('profiles')
        .select('first_group_joined_at')
        .eq('id', currentUser.id)
        .single();
      
      if (!profile?.first_group_joined_at) {
        await supabaseClient
          .from('profiles')
          .update({ 
            first_group_joined_at: new Date().toISOString(),
            onboarding_step: 2
          })
          .eq('id', currentUser.id);
      }
      
      UserState._cache.clear();
      setTimeout(() => {
        this.loadAdaptive();
      }, 500);
      
    } catch (error) {
      console.error('Error joining group:', error);
      showNotification('error', 'No se pudo unir al grupo');
    }
  },

  viewGroupActivity(groupId) {
    const modal = document.getElementById('groupActivityModal');
    const content = document.getElementById('groupActivityContent');
    const title = document.getElementById('groupActivityTitle');
    
    if (!modal || !content || !title) {
      showNotification('info', 'Función en desarrollo: Ver actividad del grupo');
      return;
    }
    
    title.innerHTML = '<i class="fas fa-chart-line"></i> Actividad del Grupo';
    
    // Mock activity data
    const activities = [
      { user: 'Ana', action: 'compartió una reseña de "El Nombre del Viento"', time: '2 horas' },
      { user: 'Carlos', action: 'propuso el próximo libro: "Cien años de soledad"', time: '1 día' },
      { user: 'María', action: 'organizó encuentro presencial para el sábado', time: '2 días' },
      { user: 'Luis', action: 'añadió 3 libros nuevos a la biblioteca del grupo', time: '3 días' }
    ];
    
    content.innerHTML = `
      <div class="activity-feed">
        <h5 style="margin-bottom:1rem">Actividad Reciente</h5>
        ${activities.map(activity => `
          <div class="activity-item">
            <div class="member-avatar">${activity.user.charAt(0)}</div>
            <div style="flex:1">
              <strong>${activity.user}</strong> ${activity.action}
              <div class="hint">Hace ${activity.time}</div>
            </div>
          </div>
        `).join('')}
      </div>
      
      <div style="margin-top:1.5rem">
        <h5>Miembros Activos (4)</h5>
        <div class="member-list">
          ${['Ana', 'Carlos', 'María', 'Luis'].map(name => `
            <div class="member-avatar" title="${name}">${name.charAt(0)}</div>
          `).join('')}
        </div>
      </div>
      
      <div style="margin-top:1.5rem;text-align:center">
        <button class="btn btn-primary" onclick="Modals.close('groupActivityModal')">
          <i class="fas fa-check"></i> Entendido
        </button>
      </div>
    `;
    
    modal.classList.add('active');
    document.body.classList.add('modal-open');
  },
  
  loadGuestView() {
    const discoveryCard = document.getElementById('discoveryCard');
    if (discoveryCard) {
      discoveryCard.innerHTML = `
        <div class="row">
          <div style="display:flex;align-items:center;gap:12px">
            <i class="fas fa-eye" style="font-size:2rem;color:var(--primary-wood)"></i>
            <div>
              <div style="font-weight:700">Explora Nuestra Comunidad</div>
              <div class="hint">Crea una cuenta para unirte a grupos de aprendizaje</div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="Guest.goToSignup()">
            <i class="fas fa-user-plus"></i> Crear Cuenta
          </button>
        </div>`;
    }
    
    this.loadAvailableGroups();
  },
  
  loadDefaultView() {
    const discoveryCard = document.getElementById('discoveryCard');
    if (discoveryCard) {
      discoveryCard.innerHTML = `
        <div class="row">
          <div style="display:flex;align-items:center;gap:12px">
            <i class="fas fa-compass" style="font-size:2rem;color:var(--primary-wood)"></i>
            <div>
              <div style="font-weight:700">Comunidad de Aprendizaje</div>
              <div class="hint">Conecta con personas afines a tus intereses</div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="InterestDiscovery.showWelcome()">
            <i class="fas fa-rocket"></i> Explorar
          </button>
        </div>`;
    }
    this.loadAvailableGroups();
  },

  async hideAdvancedFeatures() {
    const myGroupsSection = document.getElementById('myGroupsSection');
    if (myGroupsSection) myGroupsSection.style.display = 'none';
  },

  async highlightAvailableGroups() {
    const availableSection = document.querySelector('h4[style*="margin:1rem 0 .5rem"]');
    if (availableSection && availableSection.textContent.includes('Grupos Temáticos')) {
      availableSection.style.color = 'var(--primary-wood)';
      availableSection.style.fontWeight = '700';
    }
  },

  async showPersonalizedRecommendations() {
    console.log('Showing personalized recommendations...');
  },

  async showLeadershipOptions() {
    console.log('Showing leadership options...');
  }
};

// Función para unirse al club semanal
function joinWeeklyClub() {
  if (!currentUser) {
    showNotification('info', 'Inicia sesión para unirte al club semanal');
    return;
  }
  
  if (Threema.config.connected) {
    Threema.message('WEEKLYCLUB', 'Hola, me gustaría unirme al club de ficción contemporánea. Estoy leyendo "Proyecto Hail Mary".');
  } else {
    showNotification('info', 'Configura Threema primero para unirte al club semanal');
    Threema.openConfig();
  }
}

/* ===== Initialize Application ===== */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    console.log('📱 Starting Intercambio Libros Madrid...');
    
    // EXPOSER FUNCIONES GLOBALMENTE PARA DEBUGGING
    window.InterestDiscovery = InterestDiscovery;
    window.CommunityManager = CommunityManager;
    window.Guest = Guest;
    window.Exchange = Exchange;
    
    console.log('🔧 Global functions exposed:');
    console.log('InterestDiscovery:', typeof window.InterestDiscovery);
    console.log('CommunityManager:', typeof window.CommunityManager);
    console.log('Guest:', typeof window.Guest);
    console.log('Exchange:', typeof window.Exchange);
    
    const urlParams = new URLSearchParams(window.location.search);
    const referralCode = urlParams.get('ref');
    if (referralCode && referralCode.length === 8) {
      localStorage.setItem('pendingReferralCode', referralCode);
      const cleanUrl = window.location.pathname + window.location.hash;
      history.replaceState(null, '', cleanUrl);
      console.log(`Referral code detected: ${referralCode}`);
    }
    
    if (!isConfigured()) {
      const warning = document.getElementById('configWarning');
      if (warning) {
        warning.style.display = 'block';
      }
      console.warn('⚠️ Application not properly configured');
    }
    
    const supabaseInitialized = initializeSupabase();
    if (supabaseInitialized) {
      console.log('✅ Supabase client initialized');
      await setupAuthStateListener();
      console.log('✅ Auth state listener setup complete');
    } else {
      console.warn('⚠️ Supabase not initialized - running in demo mode');
      toggleAuthViews(false);
    }
    
    if (SOCIAL_LOGIN_ENABLED.google) {
      const googleBtn = document.getElementById('googleBtn');
      if (googleBtn) googleBtn.style.display = 'flex';
    }
    if (SOCIAL_LOGIN_ENABLED.apple) {
      const appleBtn = document.getElementById('appleBtn');
      if (appleBtn) appleBtn.style.display = 'flex';
    }
    
    PasswordUI.attachChecklist('signupPassword', 'signupPwRules');
    
    const pendingCode = localStorage.getItem('pendingReferralCode');
    if (pendingCode) {
      showNotification('info', `Tienes un código de referido válido: ${pendingCode}`);
    }
    
    // FORZAR CARGA INICIAL DE COMUNIDAD SI ES NECESARIO
    setTimeout(() => {
      console.log('🚀 Forcing initial community load check...');
      console.log('InterestDiscovery:', typeof window.InterestDiscovery);
      
      const currentTab = document.querySelector('.nav-tab.active')?.dataset?.tab;
      if (currentTab === 'community') {
        console.log('📋 Community tab is active, forcing load...');
        if (window.CommunityManager && typeof CommunityManager.loadAdaptive === 'function') {
          CommunityManager.loadAdaptive();
        }
      }
    }, 2000);
    
    console.log('✅ Application initialization complete');
    
  } catch (error) {
    console.error('⚠️ Application initialization failed:', error);
    showNotification('error', 'Error al inicializar la aplicación');
  }
});

// Handle URL hash changes for deep linking
window.addEventListener('hashchange', () => {
  const hash = window.location.hash.substring(1);
  if (['matches', 'library', 'community', 'profile'].includes(hash)) {
    UI.showTab(hash);
  }
});

// Service worker registration for PWA (only on own domains)
if ('serviceWorker' in navigator && !window.location.hostname.includes('claudeusercontent.com')) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// Prevent zoom on double tap (mobile)
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// Handle network status
window.addEventListener('online', () => {
  showNotification('success', 'Conexión restaurada');
});

window.addEventListener('offline', () => {
  showNotification('warning', 'Sin conexión a internet');
});

console.log('📚 Intercambio Libros Madrid - Ready! 🏙️');
</script>

<script>
var currentTransactionType = 'exchange';
var selectedDurationDays = 15;
function _closest(el, selector){
  while (el && el !== document) {
    if (el.matches && el.matches(selector)) return el;
    el = el.parentNode;
  }
  return null;
}
function selectTransactionType(type) {
  currentTransactionType = type;
  var btns = document.querySelectorAll('.transaction-type-option');
  if (btns) for (var i=0;i<btns.length;i++) btns[i].classList.remove('active');
  var ev = window.event;
  var trg = ev ? _closest(ev.target, '.transaction-type-option') : null;
  if (trg) trg.classList.add('active');
  var loanSection = document.getElementById('loanDurationSection');
  var offerLabel  = document.getElementById('offerBookLabel');
  var submitText  = document.getElementById('submitButtonText');
  if (loanSection && offerLabel && submitText) {
    if (type === 'loan') {
      loanSection.style.display = 'block';
      offerLabel.textContent = 'Tu libro para prestar';
      submitText.textContent  = 'Enviar solicitud de préstamo';
    } else {
      loanSection.style.display = 'none';
      offerLabel.textContent = 'Tu libro para intercambiar';
      submitText.textContent = 'Enviar propuesta de intercambio';
    }
  }
  updateLoanInfo();
}
function selectDuration(days) {
  selectedDurationDays = days;
  var custom = document.getElementById('customDurationDays');
  if (custom) custom.value = '';
  var opts = document.querySelectorAll('.duration-option');
  if (opts) for (var i=0;i<opts.length;i++) opts[i].classList.remove('selected');
  var ev = window.event;
  var trg = ev ? _closest(ev.target, '.duration-option') : null;
  if (trg) trg.classList.add('selected');
  updateLoanInfo();
}
function selectCustomDuration() {
  var el = document.getElementById('customDurationDays');
  var v = parseInt((el && el.value) ? el.value : '0', 10);
  if (v && v > 0 && v <= 365) {
    selectedDurationDays = v;
    var opts = document.querySelectorAll('.duration-option');
    if (opts) for (var i=0;i<opts.length;i++) opts[i].classList.remove('selected');
    updateLoanInfo();
  }
}
function updateLoanInfo() {
  if (currentTransactionType !== 'loan') return;
  var d = new Date();
  d.setDate(d.getDate() + selectedDurationDays);
  var formatted = d.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
  var returnDate = document.getElementById('returnDate');
  if (returnDate) returnDate.textContent = formatted;
  var box = document.querySelector('#loanInfoBox span');
  if (box) box.innerHTML = 'Préstamo por <strong>' + selectedDurationDays + ' días</strong>. Devuelve antes del <strong>' + formatted + '</strong>.';
}
document.addEventListener('DOMContentLoaded', updateLoanInfo);
</script>
<script src="ascension-bundle.min.js"></script>
</body>
</html>
